/**
 * osjs-apps-corewm - 
 * @author 
 * @version v1.0.0
 * @link 
 * @license 
 */
define(["./locales"],function(t){"use strict";const e=OSjs.require("core/locales").createLocalizer(t),i=OSjs.require("utils/fs"),s=OSjs.require("gui/menu"),n=OSjs.require("utils/dom"),o=OSjs.require("utils/gui"),r=OSjs.require("vfs/fs"),h=OSjs.require("core/process"),a=OSjs.require("core/theme"),c=OSjs.require("core/dialog"),l=OSjs.require("vfs/file"),u=OSjs.require("core/mount-manager"),p=OSjs.require("gui/element"),d=OSjs.require("core/window-manager");function m(t,s,n){c.create("Input",{value:t,message:e("Create in {0}",s)},function(t,e,o){o&&n(new l(i.pathJoin(s,o)))})}return class{constructor(t){this.dialog=null,this.$iconview=null,this.$element=document.createElement("gui-icon-view"),this.$element.setAttribute("data-multiple","false"),this.$element.id="CoreWMDesktopIconView",this.shortcutCache=[],this.refreshTimeout=null,o.createDroppable(this.$element,{onOver:function(e,i,s){t.onDropOver(e,i,s)},onLeave:function(){t.onDropLeave()},onDrop:function(){t.onDrop()},onItemDropped:function(e,i,s,n){t.onDropItem(e,i,s,n)},onFilesDropped:function(e,i,s,n){t.onDropFile(e,i,s,n)}}),this.$iconview=p.createFromNode(this.$element),this.$iconview.build(),this.$iconview.on("select",()=>{if(t){const e=t.getCurrentWindow();e&&e._blur()}}).on("activate",t=>{t&&t.detail&&t.detail.entries.forEach(t=>{const e=t.data,i=new l(e);h.createFromFile(i,e.args)})}).on("contextmenu",t=>{t&&t.detail&&t.detail.entries&&this.createContextMenu(t.detail.entries[0],t)}),this._refresh()}destroy(){n.$remove(this.$element),this.refreshTimeout=clearTimeout(this.refreshTimeout),this.$element=null,this.$iconview=null,this.dialog&&this.dialog.destroy(),this.dialog=null,this.shortcutCache=[]}blur(){p.createFromNode(this.$element).set("value",null)}getRoot(){return this.$element}resize(t){const e=this.getRoot(),i=t.getWindowSpace();e&&(e.style.top=i.top+"px",e.style.left=i.left+"px",e.style.width=i.width+"px",e.style.height=i.height+"px")}_refresh(t){const e=d.instance.getSetting("desktopPath"),s=i.pathJoin(e,".shortcuts.json");this.shortcutCache=[],this.refreshTimeout=clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout(()=>{r.scandir(e,{backlink:!1}).then(t=>{if(this.$iconview){const e=t.map(t=>{if("application"===t.type||!0===t.shortcut){const e=new l(t);e.shortcut=!0;const i=this.shortcutCache.push(e)-1,s=new l(t);return s.__index=i,{_type:t.type,icon:a.getFileIcon(t,"32x32"),label:t.filename,value:s,args:t.args||{}}}return{_type:"vfs",icon:a.getFileIcon(t,"32x32"),label:t.filename,value:t}}).filter(function(t){return t.value.path!==s});this.$iconview.clear().add(e)}})},150)}_save(t){const e=d.instance.getSetting("desktopPath"),s=i.pathJoin(e,".shortcuts.json"),n=this.shortcutCache;r.mkdir(i.dirname(s)).finally(()=>{r.write(s,JSON.stringify(n,null,4)).then(()=>{t&&this._refresh()})})}updateShortcut(t,e){const i=this.shortcutCache[t.__index];i.path===t.path&&(Object.keys(e).forEach(function(t){i[t]=e[t]}),this._save(!0))}getShortcutByPath(t){let e=null,i=-1;return this.shortcutCache.forEach(function(s,n){e||"application"!==s.type&&s.path===t&&(e=s,i=n)}),{item:e,index:i}}addShortcut(t,e,i){["icon"].forEach(function(e){t[e]&&delete t[e]}),"application"===t.type&&(t.args=t.args||{}),t.shortcut=!0,this.shortcutCache.push(t),this._save(!0)}removeShortcut(t){const e=this.shortcutCache[t.__index];e&&e.path===t.path&&(this.shortcutCache.splice(t.__index,1),this._save(!0))}_getContextMenu(t){const i=d.instance.getSetting("desktopPath"),s=[{title:e("LBL_UPLOAD"),onClick:()=>{c.create("FileUpload",{dest:i},()=>{this._refresh()})}},{title:e("LBL_CREATE"),menu:[{title:e("LBL_FILE"),onClick:()=>{m("New file",i,t=>{r.write(t,"").catch(t=>{OSjs.error("CoreWM",e("ERR_VFSMODULE_MKFILE"),t)})})}},{title:e("LBL_DIRECTORY"),onClick:()=>{m("New directory",i,t=>{r.mkdir(t).catch(t=>{OSjs.error("CoreWM",e("ERR_VFSMODULE_MKDIR"),t)})})}}]}];if(t&&t.data){const n=t.data;"application"===n.type&&s.push({title:e("Edit shortcut"),onClick:()=>this.openShortcutEdit(n)});const o=u.getModuleFromPath(n.path);o&&o.option("root")===i?s.push({title:e("LBL_DELETE"),onClick:()=>r.unlink(n)}):s.push({title:e("Remove shortcut"),onClick:()=>this.removeShortcut(n)})}return s}createContextMenu(t,e){const i=d.instance._getContextMenu(t);s.create(i,e)}openShortcutEdit(t){this.dialog&&this.dialog._close();const e=d.instance;this.dialog=new class extends c{constructor(t,e,i){super("IconViewShortcutDialog",{title:"Edit Launcher",icon:"status/appointment-soon.png",width:400,height:220,allow_maximize:!1,allow_resize:!1,allow_minimize:!1},()=>{}),this.scheme=e,this.values={path:t.path,filename:t.filename,args:t.args||{}},this.cb=i||function(){}}init(t,e){const i=super.init(...arguments);return this._render(this._name,this.scheme),this._find("InputShortcutLaunch").set("value",this.values.path),this._find("InputShortcutLabel").set("value",this.values.filename),this._find("InputTooltipFormatString").set("value",JSON.stringify(this.values.args||{})),this._find("ButtonApply").on("click",()=>{this.applySettings(),this._close("ok")}),this._find("ButtonCancel").on("click",()=>{this._close()}),i}applySettings(){this.values.path=this._find("InputShortcutLaunch").get("value"),this.values.filename=this._find("InputShortcutLabel").get("value"),this.values.args=JSON.parse(this._find("InputTooltipFormatString").get("value")||{})}_close(t){return this.cb(t,this.values),super._close(...arguments)}}(t,e._scheme,(e,i)=>{"ok"===e&&this.updateShortcut(t,i),this.dialog=null}),e.addWindow(this.dialog,!0)}}});
//# sourceMappingURL=sourcemaps/iconview.js.map
