{"version":3,"sources":["panelitems/search.js"],"names":["define","PanelItem","DOM","OSjs","require","Hooks","Theme","Events","Locales","Keycodes","Process","FileMetadata","SearchEngine","WindowManager","[object Object]","settings","super","this","$ul","$box","$input","$message","visible","hookId","currentIndex","currentCount","root","init","arguments","img","document","createElement","src","getIcon","input","setAttribute","guinput","appendChild","ul","createTextNode","_","className","self","keyEvents","DOWN","navigateDown","UP","navigateUp","ESC","hide","ENTER","ev","value","length","search","navigateOpen","addHook","$bind","stopPropagation","show","keyCode","preventDefault","call","target","tagName","launch","focus","li","_$container","body","create","category","removeHook","$unbind","_$root","$remove","destroy","getAttribute","args","JSON","parse","file","mime","type","path","createFromFile","space","instance","getWindowSpace","querySelector","$empty","style","marginTop","String","top","display","q","limit","recursive","then","result","renderResult","catch","errors","console","error","list","forEach","l","icon","title","description","node","application","stringify","child","children","querySelectorAll","el","$removeClass","$addClass","updateSelection"],"mappings":"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","file":"../../panelitems/search.js","sourcesContent":["define(['../panelitem'], function (PanelItem) {\n    'use strict';\n    const DOM = OSjs.require('utils/dom');\n    const Hooks = OSjs.require('helpers/hooks');\n    const Theme = OSjs.require('core/theme');\n    const Events = OSjs.require('utils/events');\n    const Locales = OSjs.require('core/locales');\n    const Keycodes = OSjs.require('utils/keycodes');\n    const Process = OSjs.require('core/process');\n    const FileMetadata = OSjs.require('vfs/file');\n    const SearchEngine = OSjs.require('core/search-engine');\n    const WindowManager = OSjs.require('core/window-manager');\n    return class PanelItemSearch extends PanelItem {\n        constructor(settings) {\n            super('PanelItemSearch corewm-panel-right', 'Search', settings, {});\n            this.$ul = null;\n            this.$box = null;\n            this.$input = null;\n            this.$message = null;\n            this.visible = false;\n            this.hookId = -1;\n            this.currentIndex = -1;\n            this.currentCount = 0;\n        }\n        init() {\n            const root = super.init(...arguments);\n            const img = document.createElement('img');\n            img.src = Theme.getIcon('actions/system-search.png');\n            const input = document.createElement('input');\n            input.setAttribute('type', 'text');\n            const guinput = document.createElement('gui-text');\n            guinput.appendChild(input);\n            const ul = document.createElement('ul');\n            this.$message = document.createElement('div');\n            this.$message.appendChild(document.createTextNode(Locales._('SEARCH_LOADING')));\n            this.$box = document.createElement('corewm-search');\n            this.$box.className = 'custom-notification';\n            this.$box.appendChild(guinput);\n            this.$box.appendChild(this.$message);\n            this.$box.appendChild(ul);\n            const self = this;\n            const keyEvents = {};\n            keyEvents[Keycodes.DOWN] = () => this.navigateDown();\n            keyEvents[Keycodes.UP] = () => this.navigateUp();\n            keyEvents[Keycodes.ESC] = () => this.hide();\n            keyEvents[Keycodes.ENTER] = function (ev) {\n                if (this.value.length) {\n                    self.search(this.value);\n                    this.value = '';\n                } else {\n                    self.navigateOpen();\n                }\n            };\n            Hooks.addHook('menuBlur', () => this.hide());\n            Events.$bind(root, 'click', function (ev) {\n                ev.stopPropagation();\n                if (self.visible) {\n                    self.hide();\n                } else {\n                    self.show();\n                }\n            });\n            Events.$bind(input, 'mousedown', ev => ev.stopPropagation());\n            Events.$bind(input, 'keydown', function (ev) {\n                if (keyEvents[ev.keyCode]) {\n                    ev.preventDefault();\n                    ev.stopPropagation();\n                    keyEvents[ev.keyCode].call(this, ev);\n                }\n            });\n            Events.$bind(ul, 'mousedown', ev => ev.stopPropagation());\n            Events.$bind(ul, 'click', ev => {\n                const target = ev.target;\n                if (target.tagName === 'LI') {\n                    self.launch(target);\n                }\n            });\n            Events.$bind(this.$box, 'mousedown', () => {\n                if (input) {\n                    input.focus();\n                }\n            });\n            const li = document.createElement('li');\n            li.appendChild(img);\n            this.$ul = ul;\n            this.$input = input;\n            this._$container.appendChild(li);\n            document.body.appendChild(this.$box);\n            return root;\n        }\n        applySettings() {\n        }\n        openSettings() {\n            Process.create('ApplicationSettings', { category: 'search' });\n        }\n        destroy() {\n            if (this.hookId >= 0) {\n                Hooks.removeHook(this.hookId);\n            }\n            Events.$unbind(this._$root, 'click');\n            Events.$unbind(this.$input, 'mousedown');\n            Events.$unbind(this.$input, 'keydown');\n            Events.$unbind(this.$ul, 'mousedown');\n            Events.$unbind(this.$ul, 'click');\n            Events.$unbind(this.$box, 'mousedown');\n            this.$message = DOM.$remove(this.$message);\n            this.$input = DOM.$remove(this.$input);\n            this.$box = DOM.$remove(this.$box);\n            this.$ul = DOM.$remove(this.$ul);\n            return super.destroy(...arguments);\n        }\n        launch(target) {\n            const launch = target.getAttribute('data-launch');\n            const args = JSON.parse(target.getAttribute('data-args'));\n            const file = target.getAttribute('data-file');\n            const mime = target.getAttribute('data-mime');\n            const type = target.getAttribute('data-type');\n            if (file) {\n                if (type === 'dir') {\n                    Process.create('ApplicationFileManager', { path: file });\n                } else {\n                    Process.createFromFile(new FileMetadata(file, mime));\n                }\n            } else {\n                Process.create(launch, args);\n            }\n            this.hide();\n        }\n        show() {\n            if (!this.$box || this.visible) {\n                return;\n            }\n            const wm = WindowManager.instance;\n            const space = wm.getWindowSpace(true);\n            const input = this.$box.querySelector('input');\n            DOM.$empty(this.$box.querySelector('ul'));\n            this.$box.style.marginTop = String(space.top) + 'px';\n            this.$box.setAttribute('data-visible', String(true));\n            if (input) {\n                input.value = '';\n                input.focus();\n            }\n            this.visible = true;\n            this.$message.style.display = 'none';\n        }\n        hide() {\n            if (!this.$box || !this.visible) {\n                return;\n            }\n            this.$box.setAttribute('data-visible', String(false));\n            this.visible = false;\n        }\n        search(q) {\n            if (!this.$box) {\n                return;\n            }\n            this.currentIndex = -1;\n            this.currentCount = 0;\n            DOM.$empty(this.$message);\n            this.$message.appendChild(document.createTextNode(Locales._('SEARCH_LOADING')));\n            this.$message.style.display = 'block';\n            SearchEngine.search(q, {\n                limit: 10,\n                recursive: true\n            }).then(result => {\n                this.renderResult(result);\n            }).catch(errors => {\n                console.error('PanelItemSearch::search()', 'errors', errors);\n            });\n        }\n        renderResult(list) {\n            if (!this.$box) {\n                return;\n            }\n            const root = this.$box.querySelector('ul');\n            DOM.$empty(root);\n            this.currentCount = list.length;\n            if (this.currentCount) {\n                this.$message.style.display = 'none';\n            } else {\n                DOM.$empty(this.$message);\n                this.$message.appendChild(document.createTextNode(Locales._('SEARCH_NO_RESULTS')));\n                this.$message.style.display = 'block';\n            }\n            list.forEach(function (l) {\n                const img = document.createElement('img');\n                img.src = l.icon;\n                const title = document.createElement('div');\n                title.className = 'Title';\n                title.appendChild(document.createTextNode(l.title));\n                const description = document.createElement('div');\n                description.className = 'Message';\n                description.appendChild(document.createTextNode(l.description));\n                const node = document.createElement('li');\n                node.setAttribute('data-launch', l.launch.application);\n                node.setAttribute('data-args', JSON.stringify(l.launch.args));\n                if (l.launch.file) {\n                    node.setAttribute('data-file', l.launch.file.path);\n                    node.setAttribute('data-mime', l.launch.file.mime);\n                    node.setAttribute('data-type', l.launch.file.type);\n                }\n                node.appendChild(img);\n                node.appendChild(title);\n                node.appendChild(description);\n                root.appendChild(node);\n            });\n        }\n        updateSelection() {\n            const root = this.$box.querySelector('ul');\n            const child = root.children[this.currentIndex];\n            root.querySelectorAll('li').forEach(function (el) {\n                DOM.$removeClass(el, 'active');\n            });\n            DOM.$addClass(child, 'active');\n        }\n        navigateUp() {\n            if (!this.currentCount) {\n                return;\n            }\n            if (this.currentIndex > 0) {\n                this.currentIndex--;\n            } else {\n                this.currentIndex = this.currentCount - 1;\n            }\n            this.updateSelection();\n        }\n        navigateDown() {\n            if (!this.currentCount) {\n                return;\n            }\n            if (this.currentIndex < 0 || this.currentIndex >= this.currentCount - 1) {\n                this.currentIndex = 0;\n            } else {\n                this.currentIndex++;\n            }\n            this.updateSelection();\n        }\n        navigateOpen() {\n            if (this.currentIndex === -1 || !this.currentCount) {\n                return;\n            }\n            const root = this.$box.querySelector('ul');\n            const child = root.children[this.currentIndex];\n            if (child) {\n                this.launch(child);\n            }\n        }\n    };\n});"]}