/**
 * osjs-apps-corewm - 
 * @author 
 * @version v1.0.0
 * @link 
 * @license 
 */
define(["./locales"],function(t){"use strict";const i=OSjs.require("core/locales").createLocalizer(t),e=OSjs.require("gui/menu"),s=OSjs.require("utils/dom"),n=OSjs.require("utils/misc"),o=OSjs.require("utils/events"),h=OSjs.require("core/window-manager"),_=3e3,d=1e3,l={aspect:!1,width:100,height:100,minWidth:64,minHeight:64,maxHeight:500,maxWidth:500,left:0,right:null,top:0,bottom:null,locked:!1,canvas:!1,resizable:!1,viewBox:!1,frequency:2,custom:{},settings:{enabled:!1,name:"CoreWMWidgetSettingsWindow",title:i("LBL_SETTINGS"),width:300,height:300}};function m(t){var i=null,e=t._getNormalizedPosition(),s=t._getDimension(),n={x:0,y:0};function h(h,_,d){h.preventDefault(),t._locked||(i=clearTimeout(i),n=_,e=t._getNormalizedPosition(),s=t._getDimension(),o.$bind(window,"mousemove:modifywidget",function(i,o){var h=o.x-n.x,_=o.y-n.y,l="move"===d?{left:e.left+h,top:e.top+_}:function(i,e){if(!0===t._options.aspect){var n=s.width+i;return{width:n,height:n/t._aspect}}return{width:s.width+i,height:s.height+e}}(h,_);t._onMouseMove(i,l,d)}),o.$bind(window,"mouseup:modifywidget",function(i,e){o.$unbind(window,"mousemove:modifywidget"),o.$unbind(window,"mouseup:modifywidget"),t._onMouseUp(i,e,d)}),t._windowWidth=window.innerWidth,t._windowHeight=window.innerHeight,t._onMouseDown(h,_,d))}o.$bind(t._$element,"mousedown:movewidget",function(t,i){h(t,i,"move")}),o.$bind(t._$resize,"mousedown:resizewidget",function(t,i){t.stopPropagation(),h(t,i,"resize")}),o.$bind(t._$element,"click:showenvelope",function(e){i=clearTimeout(i),t._showEnvelope()}),o.$bind(t._$element,"mouseover:showenvelope",function(){i=clearTimeout(i),i=setTimeout(function(){t._showEnvelope()},_)}),o.$bind(t._$element,"mouseout:hideenvelope",function(e){i=clearTimeout(i),i=setTimeout(function(){t._hideEnvelope()},d)}),o.$bind(t._$element,"contextmenu:widgetcontext",function(i){t._onContextMenu(i)})}function r(t){return void 0!==t&&null!==t&&!isNaN(t)}return class{constructor(t,i,e){i=n.mergeObject(n.cloneObject(l),i||{}),this._aspect=!0===i.aspect?i.width/i.height:"number"==typeof i.aspect?i.aspect:1,!1!==i.aspect&&(i.minHeight=i.width/this._aspect,i.maxHeight=i.maxWidth/this._aspect),i.viewBox&&(i.resizable=!0,!0===i.viewBox&&(i.viewBox="0 0 "+i.width+" "+i.height)),this._position={left:e.get("left",i.left),top:e.get("top",i.top),right:e.get("right",i.right),bottom:e.get("bottom",i.bottom)},this._dimension={height:e.get("height",i.height),width:e.get("width",i.width)},this._name=t,this._settings=e,this._options=i,this._isManipulating=!1,this._windowWidth=window.innerWidth,this._windowHeight=window.innerHeight,this._requestId=null,this._saveTimeout=null,this._settingsWindow=null,this._locked=e.get("locked",!1),this._$element=null,this._$resize=null,this._$canvas=null,this._$context=null,n.mergeObject(this._options.settings,e.get("settings",{})),console.debug("Widget::construct()",this._name,this._settings.get())}init(t){return this._windowWidth=window.innerWidth,this._windowHeight=window.innerHeight,this._$element=document.createElement("corewm-widget"),this._$resize=document.createElement("corewm-widget-resize"),this._options.canvas&&(this._$canvas=document.createElement("canvas"),this._options.viewBox&&this._$canvas.setAttribute("viewBox",this._options.viewBox),this._$context=this._$canvas.getContext("2d"),this._$element.appendChild(this._$canvas)),m(this),this._updatePosition(),this._updateDimension(),this._setLock(this._locked),s.$addClass(this._$element,"Widget"+this._name),this._$element.appendChild(this._$resize),t.appendChild(this._$element),this._$element}_inited(){var t,i,e,s;this.onInited(),this.onResize(this._dimension);const n=()=>{window.requestAnimationFrame(n),i=Date.now(),(s=i-e)>t&&(e=i-s%t,this.onRender())};if(this._$canvas){var o=Math.min(this._options.frequency,1);this._requestId=window.requestAnimationFrame(function(){t=1e3/o,e=Date.now(),n()})}}destroy(){o.$unbind(window,"mousemove:modifywidget"),o.$unbind(window,"mouseup:modifywidget"),o.$unbind(this._$resize,"mousedown:resizewidget"),o.$unbind(this._$element,"mousedown:movewidget"),o.$unbind(this._$element,"click:showenvelope"),o.$unbind(this._$element,"mouseover:showenvelope"),o.$unbind(this._$element,"mouseout:hideenvelope"),o.$unbind(this._$element,"contextmenu:widgetcontext"),this._saveTimeout=clearTimeout(this._saveTimeout),this._requestId&&window.cancelAnimationFrame(this._requestId),this._requestId=null,this._settingsWindow&&this._settingsWindow.destroy(),this._settingsWindow=null,this._$canvas=s.$remove(this._$canvas),this._$resize=s.$remove(this._$resize),this._$element=s.$remove(this._$element),this._$context=null}blur(){}_onMouseDown(t,i,e){if(this._saveTimeout=clearTimeout(this._saveTimeout),s.$addClass(this._$element,"corewm-widget-active"),"resize"===e){var n=this._getNormalizedPosition();this._setPosition(n)}}_onMouseMove(t,i,e){this._isManipulating=!0,"move"===e?(this._setPosition(i,!0),this.onMove(this._position)):(this._setDimension(i),this.onResize(this._dimension))}_onMouseUp(t,i,e){this._isManipulating=!1,this._resizeTimeout=clearTimeout(this._resizeTimeout),s.$removeClass(this._$element,"corewm-widget-active"),this._hideEnvelope(),"resize"===e&&this._setPosition(null,!0),this._saveTimeout=clearTimeout(this._saveTimeout),this._saveTimeout=setTimeout(()=>{this._saveOptions()},500)}_onContextMenu(t){var s=this.onContextMenu(t),n=[{title:this._locked?i("LBL_UNLOCK"):i("LBL_LOCK"),onClick:()=>{this._setLock(),this._saveOptions()}}];!0!==s&&(s instanceof Array&&(n=s.concat(n)),this._options.settings.enabled&&n.push({title:i("Open {0} Settings",i(this._name)),onClick:t=>{this._openSettings(t)}})),e.create(n,t)}_saveOptions(t){void 0!==t&&(this._options.settings.tree=t);var i={width:this._dimension.width,height:this._dimension.height,right:this._position.right,left:r(this._position.right)?null:this._position.left,bottom:this._position.bottom,top:r(this._position.bottom)?null:this._position.top,locked:this._locked,settings:{tree:this._options.settings.tree}};this._settings.set(null,i,!0)}_openSettings(t){if(this._settingsWindow)this._settingsWindow._focus();else{var i=h.instance,e=new Window(this._options.settings.name,{title:this._options.settings.title,width:this._options.settings.width,height:this._options.settings.height},null,i._scheme);e._on("init",(i,s)=>{var n=this.onOpenSettings(i,s,t);e._render(n.id),e._find("ButtonOK").on("click",()=>{var e=n.save(i,s,t);this._saveOptions(e)}),n.render(i,s,t)}),e._on("close",()=>{this._settingsWindow=null}),this._settingsWindow=i.addWindow(e,!0)}}_showEnvelope(){this._$element&&s.$addClass(this._$element,"corewm-widget-envelope")}_hideEnvelope(){this._$element&&!this._isManipulating&&s.$removeClass(this._$element,"corewm-widget-envelope")}_setPosition(t,i){t=t||n.cloneObject(this._position),this._position.top=t.top,this._position.left=t.left,this._position.bottom=null,this._position.right=null,i&&(this._isPastHalf("vertical",t)&&(this._position.top=null,this._position.bottom=this._windowHeight-this._dimension.height-t.top),this._isPastHalf("horizontal",t)&&(this._position.left=null,this._position.right=this._windowWidth-this._dimension.width-t.left)),this._updatePosition()}_setDimension(t){var i=this._options,e=Math.min(Math.max(t.width,i.minWidth),i.maxWidth),s=Math.min(Math.max(t.height,i.minHeight),i.maxHeight);!0===this._options.aspect&&(s=e/this._aspect),this._dimension.width=e,this._dimension.height=s,this._updateDimension()}_setLock(t){"boolean"!=typeof t&&(t=!this._locked),this._locked=t,this._$element&&this._$element.setAttribute("data-locked",String(this._locked))}_updatePosition(){this._$element&&(r(this._position.right)?(this._$element.style.left="auto",this._$element.style.right=String(this._position.right)+"px"):(this._$element.style.left=String(this._position.left)+"px",this._$element.style.right="auto"),r(this._position.bottom)?(this._$element.style.top="auto",this._$element.style.bottom=String(this._position.bottom)+"px"):(this._$element.style.top=String(this._position.top)+"px",this._$element.style.bottom="auto"))}_updateDimension(){this._$element&&(this._$element.style.width=String(this._dimension.width)+"px",this._$element.style.height=String(this._dimension.height)+"px"),this._$canvas&&(this._$canvas.width=this._dimension.width||64,this._$canvas.height=this._dimension.height||64)}_getNormalizedPosition(){var t=this._position.left;r(this._position.right)&&(t=this._windowWidth-this._position.right-this._dimension.width);var i=this._position.top;return r(this._position.bottom)&&(i=this._windowHeight-this._position.bottom-this._dimension.height),{left:t,top:i}}_getDimension(){return{width:this._dimension.width,height:this._dimension.height}}_getPosition(){return{left:this._position.left,top:this._position.top,right:this._position.right,bottom:this._position.bottom}}_setSetting(t,i,e){this._options.settings.tree[t]=i,e&&this._saveOptions()}_getSetting(t,i){if(void 0===this._options.settings||void 0===this._options.settings.tree)return i;var e=this._options.settings.tree[t];return void 0===e?i:e}_isPastHalf(t,i){i=i||this._position;var e=this._windowWidth/2,s=i.left+this._dimension.width/2;if("horizontal"===t)return s>=e;var n=this._windowHeight/2;return i.top+this._dimension.height/2>=n}onMove(){}onResize(){}onRender(){}onInited(){}onContextMenu(t){}onOpenSettings(t,i,e){return{id:null,save:function(){return{}},render:function(){}}}}});
//# sourceMappingURL=sourcemaps/widget.js.map
