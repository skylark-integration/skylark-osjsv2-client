/**
 * osjs-apps-corewm - 
 * @author 
 * @version v1.0.0
 * @link 
 * @license 
 */
define(["./locales","./windowswitcher","./iconview","./panel","./widgets/digitalclock","./widgets/analogclock","./panelitems/appmenu","./panelitems/buttons","./panelitems/clock","./panelitems/notificationarea","./panelitems/search","./panelitems/weather","./panelitems/windowlist","./scheme.html"],function(t,e,i,o,n,s,r,c,a,l,g,u,p,h){"use strict";const d=OSjs.require("gui/menu"),m=OSjs.require("core/locales"),w=OSjs.require("gui/scheme"),f=OSjs.require("core/config"),S=OSjs.require("core/authenticator"),y=OSjs.require("core/application"),_=OSjs.require("core/package-manager"),b=OSjs.require("core/window-manager"),k=OSjs.require("helpers/settings-fragment"),I=OSjs.require("core/settings-manager"),O=OSjs.require("utils/events"),C=OSjs.require("utils/compability"),W=OSjs.require("vfs/file"),M=OSjs.require("gui/notification"),V=OSjs.require("core/theme"),v=OSjs.require("utils/dom"),D=OSjs.require("utils/colors"),j=OSjs.require("utils/misc"),E=OSjs.require("core/init"),P=OSjs.require("utils/gui"),A=OSjs.require("vfs/fs"),T=OSjs.require("utils/fs"),q=OSjs.require("helpers/service-notification-icon"),x=10;function N(t){const e=C.getCompability();let i={animations:e.css.animation,useTouchMenu:e.touch};return t&&(i=j.mergeObject(i,t)),i}const H=m.createLocalizer(t);OSjs.Applications.CoreWM=class extends b{constructor(t,e){const i=t.defaults||{};function o(t,e,i,o){e&&e._onKeyEvent(t,"keydown",o)}super("CoreWM",t,e,N(i)),this.panels=[],this.widgets=[],this.switcher=null,this.iconView=null,this.importedSettings=j.mergeObject(f.getConfig("SettingsManager.CoreWM"),i),this._scheme=w.fromString(h),this.generatedHotkeyMap={},this.hotkeyMap={SEARCH:function(t,e,i){if(i){const e=i.getPanel();if(e){const i=e.getItemByType(OSjs.Applications.CoreWM.PanelItems.Search);i&&(t.preventDefault(),i.show())}}},SWITCHER:function(t,e,i){i.getSetting("enableSwitcher")&&i.switcher&&i.switcher.show(t,e,i)},WINDOW_MINIMIZE:function(t,e){e&&e._minimize()},WINDOW_MAXIMIZE:function(t,e){e&&e._maximize()},WINDOW_RESTORE:function(t,e){e&&e._restore()},WINDOW_MOVE_LEFT:function(t,e){e&&e._moveTo("left")},WINDOW_MOVE_RIGHT:function(t,e){e&&e._moveTo("right")},WINDOW_MOVE_UP:function(t,e){e&&e._moveTo("top")},WINDOW_MOVE_DOWN:function(t,e){e&&e._moveTo("bottom")},SAVE:o,SAVEAS:o,OPEN:o},V.update(this.importedSettings)}setup(){this.applySettings(this._settings.get());try{A.watch(new W(this.getSetting("desktopPath"),"dir"),(t,e)=>{e&&!t.match(/^vfs:(un)?mount/)&&this.iconView&&this.iconView._refresh()})}catch(t){console.warn("Failed to apply CoreWM VFS watch",t,t.stack)}return this.initSwitcher(),this.initDesktop(),this.initPanels(),this.initWidgets(),this.initIconView(),(()=>{q.init();const t=S.instance.getUser(),e=t=>(d.create([{title:m._("TITLE_SIGN_OUT"),onClick:function(){E.logout()}}],t),!1),i=()=>{const t=document.documentElement,e=M.getIcon("_FullscreenNotification");e&&this.toggleFullscreen(e.opts._isFullscreen?document:t,!e.opts._isFullscreen)},o=t=>{const e=v.$hasClass(document.body,"debug"),i=y.getProcesses().filter(function(t){return null!==t&&t instanceof y}).map(function(t){return{title:t.__label+" (pid:"+t.__pid+")",onClick:function(){y.reload(t.__pid)}}}),o=[{title:e?"Turn off debug overlay":"Turn on debug overlay",onClick:function(){e?v.$removeClass(document.body,"debug"):v.$addClass(document.body,"debug")}},{title:"Reload manifest",onClick:function(){_.init()}},{title:"Reload running application",menu:i}];d.create(o,t)};f.getConfig("Debug")&&M.createIcon("_DeveloperNotification",{icon:V.getIcon("categories/applications-development.png","16x16"),title:"Developer Tools",onContextMenu:o,onClick:o}),this.getSetting("fullscreen")&&M.createIcon("_FullscreenNotification",{icon:V.getIcon("actions/view-fullscreen.png","16x16"),title:"Enter fullscreen",onClick:i,_isFullscreen:!1}),M.createIcon("_HandlerUserNotification",{icon:V.getIcon("status/avatar-default.png","16x16"),title:m._("TITLE_SIGNED_IN_AS_FMT",t.username),onContextMenu:e,onClick:e})})(),Promise.resolve()}destroy(t){if(!t&&!window.confirm(H("Killing this process will stop things from working!")))return!1;q.destroy();try{O.$unbind(document.body,"dragenter, dragleave, dragover, drop"),M.destroyIcon("_HandlerUserNotification"),this.iconView&&this.iconView.destroy(),this.switcher&&this.switcher.destroy(),this.destroyPanels(),this.destroyWidgets();const t=this.importedSettings;try{t.background="color"}catch(t){}}catch(t){return console.warn(t),!1}return this.switcher=null,this.iconView=null,super.destroy(...arguments)}destroyPanels(){this.panels.forEach(function(t){t.destroy()}),this.panels=[]}destroyWidgets(){this.widgets.forEach(function(t){t.destroy()}),this.widgets=[]}initSwitcher(){this.switcher=new e}initDesktop(){P.createDroppable(document.body,{onOver:(t,e,i)=>this.onDropOver(t,e,i),onLeave:()=>this.onDropLeave(),onDrop:()=>this.onDrop(),onItemDropped:(t,e,i,o)=>this.onDropItem(t,e,i,o),onFilesDropped:(t,e,i,o)=>this.onDropFile(t,e,i,o)})}initPanels(t){const e=this.getSetting("panels");let i=!1;if(!1===e?i=!0:(this.destroyPanels(),(e||[]).forEach(t=>{t.options||(t.options={});const e=new k(t.options,"CoreWM",I),n=new o("Default",e,this);n.init(document.body),(t.items||[]).forEach(t=>{try{void 0!==t.settings&&null!==t.settings||(t.settings={});let e={};try{e=new k(t.settings,"CoreWM",I)}catch(t){console.warn("An error occured while loading PanelItem settings",t),console.warn("stack",t.stack)}n.addItem(new OSjs.Applications.CoreWM.PanelItems[t.name](e)),i=!0}catch(t){console.warn("An error occured while creating PanelItem",t),console.warn("stack",t.stack),M.create({icon:V.getIcon("status/dialog-warning.png","32x32"),title:"CoreWM",message:H("An error occured while creating PanelItem: {0}",t)})}}),this.panels.push(n)})),i||M.create({timeout:0,icon:V.getIcon("status/dialog-warning.png","32x32"),title:"CoreWM",message:H("Your panel has no items. Go to settings to reset default or modify manually\n(This error may occur after upgrades of OS.js)")}),t){const t=this.panels[0];t&&t.getOntop()&&t.getPosition("top")&&setTimeout(()=>{const t=this.getWindowSpace();this._windows.forEach(function(e){e&&e._position.y<t.top&&(console.warn("CoreWM::initPanels()","I moved this window because it overlapped with a panel!",e),e._move(e._position.x,t.top))})},800),this.iconView&&this.iconView.resize(this)}setTimeout(()=>{this.setStyles(this._settings.get())},250)}initWidgets(t){this.destroyWidgets(),(this.getSetting("widgets")||[]).forEach(t=>{t.settings||(t.settings={});const e=new k(t.settings,"CoreWM",I);try{const i=new OSjs.Applications.CoreWM.Widgets[t.name](e);i.init(document.body),this.widgets.push(i),i._inited()}catch(t){console.warn("CoreWM::initWidgets()",t,t.stack)}})}initIconView(){const t=this.getSetting("enableIconView");if(!t&&this.iconView)return this.iconView.destroy(),void(this.iconView=null);t&&!this.iconView&&(this.iconView=new i(this),document.body.appendChild(this.iconView.getRoot())),setTimeout(()=>{this.iconView&&this.iconView.resize(this)},280)}resize(t,e,i){super.resize(...arguments);const o=this.getWindowSpace(),n=this.getSetting("desktopMargin"),s=this._windows;this._isResponsive||this.getSetting("moveOnResize")&&function(){let t,r,c,a,l,g=0,u=s.length;for(;g<u;g++)(t=s[g])&&(null===(r=t._getViewRect())||t._state.mimimized||(c=t._position.x,a=t._position.y,l=!1,r.left+n>e.width&&(c=o.width-t._dimension.w,l=!0),r.top+n>e.height&&(a=o.height-t._dimension.h,l=!0),l&&(c<o.left&&(c=o.left),a<o.top&&(a=o.top),t._move(c,a)),!t._state.maximized||i&&!t._restored||t._restore(!0,!1)))}()}onDropLeave(){document.body.setAttribute("data-attention","false")}onDropOver(){document.body.setAttribute("data-attention","true")}onDrop(){document.body.setAttribute("data-attention","false")}onDropItem(t,e,i,o){document.body.setAttribute("data-attention","false");const n=t=>{this.applySettings({wallpaper:t.path},!1,!0)},s=t=>{this.iconView&&this.iconView.addShortcut(t,this,!0)},r=e=>{d.create([{title:H("LBL_COPY"),onClick:()=>{const t=T.pathJoin(this.getSetting("desktopPath"),e.filename);A.copy(e,t)}},{title:H("Set as wallpaper"),onClick:()=>{n(e)}}],t)};if(i){const t=i.data;"file"===i.type?t&&t.mime&&(t.mime.match(/^image/)?this.iconView?r(t):n(t):s(t)):"application"===i.type&&s(t)}}onDropFile(t,e,i,o){A.upload({destination:"desktop:///",files:i})}onContextMenu(t){return t.target!==document.body||(t.preventDefault(),this.openDesktopMenu(t),!1)}onKeyUp(t,e){t&&(t.altKey||this.switcher&&this.switcher.hide(t,e,this))}onKeyDown(t,e){let i=!1;if(t){const o=this.generatedHotkeyMap;Object.keys(o).some(n=>!!O.keyCombination(t,n)&&(o[n](t,e,this),i=n,!0))}return i}showSettings(t){y.create("ApplicationSettings",{category:t})}eventWindow(t,e){this.panels.forEach(function(i){if(i){const o=i.getItem(OSjs.Applications.CoreWM.PanelItems.WindowList);o&&o.update(t,e)}}),"focus"===t&&this.iconView&&(this.iconView.blur(),this.widgets.forEach(function(t){t.blur()}))}getNotificationArea(){const t=this.panels[0];return t?t.getItem(OSjs.Applications.CoreWM.PanelItems.NotificationArea):null}_getContextMenu(t){let e=[];return this.iconView&&(e=this.iconView._getContextMenu(t)),e.push({title:H("Open settings"),onClick:()=>this.showSettings()}),!0===this.getSetting("enableIconView")?e.push({title:H("Hide Icons"),onClick:t=>{this.applySettings({enableIconView:!1},!1,!0)}}):e.push({title:H("Show Icons"),onClick:t=>{this.applySettings({enableIconView:!0},!1,!0)}}),e}openDesktopMenu(t){if(!1===this._emit("wm:contextmenu",[t,this]))return;const e=this._getContextMenu();d.create(e,t)}applySettings(t,e,i,o){console.group("CoreWM::applySettings()"),t=e?t:j.mergeObject(this._settings.get(),t),console.log(t),V.update(t,!0),this.setIconView(t),this.setStyles(t),i&&(this.initPanels(!0),this.initWidgets(!0),t&&!0===i&&(t.language&&(I.set("Core","Locale",t.language,o),m.setLocale(t.language)),this._settings.set(null,t,i,o))),this.generatedHotkeyMap={};const n=this._settings.get("hotkeys"),s=this;return Object.keys(n).forEach(t=>{this.generatedHotkeyMap[n[t]]=function(){const e=Array.prototype.slice.call(arguments);return e.push(t),s.hotkeyMap[t].apply(this,e)}}),console.groupEnd(),!0}setIconView(t){t.enableIconView?this.initIconView():this.iconView&&(this.iconView.destroy(),this.iconView=null)}setStyles(t){let e={},i="";t.panels&&t.panels.forEach(function(t,i){e["corewm-panel"]={},e["corewm-notification"]={},e["corewm-notification:before"]={opacity:t.options.opacity/100},e["corewm-panel:before"]={opacity:t.options.opacity/100},e[".custom-notification"]={},e[".custom-notification:before"]={opacity:t.options.opacity/100},t.options.background&&(e["corewm-panel:before"]["background-color"]=t.options.background,e["corewm-notification:before"]["background-color"]=t.options.background,e[".custom-notification:before"]["background-color"]=t.options.background),t.options.foreground&&(e["corewm-panel"].color=t.options.foreground,e["corewm-notification"].color=t.options.foreground,e[".custom-notification"].color=t.options.foreground)});let o=this.getDefaultSetting("fullscreenTrigger")||800;i+="@media all and (max-width: "+String(o)+"px) {\n",i+="application-window {\n";let n=0;const s=this.getWindowSpace(!0),r=V.getStyleTheme(!0);r&&r.style&&r.style.window&&(n=r.style.window.border),i+="top: calc("+String(s.top)+"px + "+n+") !important;\n",i+="left: calc("+String(s.left)+"px + "+n+") !important;\n",i+="right: calc("+String(n)+") !important;\n",i+="bottom: calc("+(s.bottom?String(s.bottom)+"px + ":"")+n+") !important;\n",i+="\n}",i+="\n}",e["#CoreWMDesktopIconView"]={},t.invertIconViewColor&&t.backgroundColor&&(e["#CoreWMDesktopIconView"].color=D.invertHEX(t.backgroundColor)),Object.keys(e).length&&this.createStylesheet(e,i)}getWindowSpace(t){const e=super.getWindowSpace(...arguments),i=this.getSetting("desktopMargin");return e.bottom=0,this.panels.forEach(function(t){if(t&&t.getOntop()){const i=t.getHeight();t.getAutohide()&&t.isAutoHidden()?(e.top+=x,e.height-=x):t.getPosition("top")?(e.top+=i,e.height-=i):e.height-=i,"bottom"===t._options.get("position")&&(e.bottom+=i)}}),t||i>0&&(e.top+=i,e.left+=i,e.width-=2*i,e.height-=2*i),e}getWindowPosition(t){t=void 0===t||!0===t;let e=super.getWindowPosition(...arguments);const i=t?this.getSetting("desktopMargin"):0;return e.x+=i||0,e.y+=i||0,this.panels.forEach(function(t){t&&t.getOntop()&&t.getPosition("top")&&(t.getAutohide()?e.y+=x:e.y+=t.getHeight())}),e}getSetting(t){const e=super.getSetting(...arguments);return void 0===e||null===e?N(this.importedSettings)[t]:e}getDefaultSetting(t){const e=N(this.importedSettings);return void 0!==t?e[t]:e}getPanels(){return this.panels}getPanel(t){return this.panels[t||0]}static get Widgets(){return{DigitalClock:n,AnalogClock:s}}static get PanelItems(){return{AppMenu:r,Buttons:c,Clock:a,NotificationArea:l,Search:g,Weather:u,WindowList:p}}}});
//# sourceMappingURL=sourcemaps/main.js.map
