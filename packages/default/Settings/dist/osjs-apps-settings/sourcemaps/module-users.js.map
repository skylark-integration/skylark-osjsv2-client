{"version":3,"sources":["module-users.js"],"names":["define","Translations","Locales","OSjs","require","Dialog","Config","Connection","Window","_","createLocalizer","renderUsers","win","scheme","request","command","then","users","Array","_find","clear","add","map","iter","idx","value","columns","label","id","username","name","showDialog","data","_toggleDisabled","create","message","type","ev","button","user","password","catch","err","error","action","nwin","icon","_app","__metadata","title","width","height","_on","root","render","_name","Object","keys","length","set","groups","join","on","_close","get","replace","split","_addChild","group","compatible","cfg","getConfig","indexOf","init","update","settings","wm","_action","cb","te","sel","_username","removeUser","save"],"mappings":";;;;;;;AAAAA,QAAQ,aAAc,SAAUC,GAC5B,aACA,MAAMC,EAAUC,KAAKC,QAAQ,gBACvBC,EAASF,KAAKC,QAAQ,eACtBE,EAASH,KAAKC,QAAQ,eACtBG,EAAaJ,KAAKC,QAAQ,mBAC1BI,EAASL,KAAKC,QAAQ,eACtBK,EAAIP,EAAQQ,gBAAgBT,GAClC,SAASU,EAAYC,EAAKC,GACtBN,EAAWO,QAAQ,SAAWC,QAAS,SAAUC,KAAKC,IAC9CA,aAAiBC,OACjBN,EAAIO,MAAM,aAAaC,QAAQC,IAAIJ,EAAMK,IAAI,SAAUC,EAAMC,GACzD,OACIC,MAAOF,EACPG,UACMC,MAAOJ,EAAKK,KACZD,MAAOJ,EAAKM,WACZF,MAAOJ,EAAKO,aAOtC,SAASC,EAAWnB,EAAKC,EAAQmB,EAAMJ,GAEnC,GADAhB,EAAIqB,iBAAgB,GAChBL,EAuBA,YAtBAvB,EAAO6B,OAAO,SACVC,QAAS1B,EAAE,qBACX2B,KAAM,YACP,SAAUC,EAAIC,EAAQb,GAChBA,EAILlB,EAAWO,QAAQ,SACfC,QAAS,SACTwB,MACIC,SAAUf,EACVG,GAAIA,KAETZ,KAAK,KACJJ,EAAIqB,iBAAgB,GACpBtB,EAAYC,KACb6B,MAAMC,IACL9B,EAAIqB,iBAAgB,GACpB9B,KAAKwC,MAAM,WAAYlC,EAAE,8BAA+BiC,KAdxD9B,EAAIqB,iBAAgB,KAmBhC,MAAMW,EAAkB,OAATZ,EAAgB,MAAQ,OACvCA,EAAOA,MACP,MAAMa,EAAO,IAAIrC,EAAO,sBACpBsC,KAAMlC,EAAImC,KAAKC,WAAWF,KAC1BG,MAAOrC,EAAImC,KAAKC,WAAWlB,KAC3BoB,MAAO,IACPC,OAAQ,KACTvC,EAAImC,MACPF,EAAKO,IAAI,UAAW,SAAUC,GAC1BzC,EAAIqB,iBAAgB,KAExBY,EAAKO,IAAI,OAAQ,SAAUC,GACvBxC,EAAOyC,OAAOT,EAAMA,EAAKU,OACrBC,OAAOC,KAAKzB,GAAM0B,SAClBb,EAAK1B,MAAM,gBAAgBwC,IAAI,QAAS3B,EAAKH,UAC7CgB,EAAK1B,MAAM,YAAYwC,IAAI,QAAS3B,EAAKF,MACzCe,EAAK1B,MAAM,cAAcwC,IAAI,SAAU3B,EAAK4B,YAAcC,KAAK,OAEnEhB,EAAK1B,MAAM,eAAe2C,GAAG,QAAS,WAClCjB,EAAKkB,WAETlB,EAAK1B,MAAM,YAAY2C,GAAG,QAAS,WAC/B9B,EAAKH,SAAWgB,EAAK1B,MAAM,gBAAgB6C,IAAI,SAC/ChC,EAAKF,KAAOe,EAAK1B,MAAM,YAAY6C,IAAI,UAAYhC,EAAKH,SACxDG,EAAK4B,OAASf,EAAK1B,MAAM,cAAc6C,IAAI,SAASC,QAAQ,MAAO,IAAIC,MAAM,KACxElC,EAAKH,UAAaG,EAAK4B,OAI5BrD,EAAWO,QAAQ,SACfC,QAAS6B,EACTL,KAAMP,IACPhB,KAAK,KACJL,EAAYC,GACZiC,EAAKkB,WACNtB,MAAMC,IACLvC,KAAKwC,MAAM,WAAYlC,EAAE,8BAA+BiC,KAVxDG,EAAKkB,aAcjBnD,EAAIuD,UAAUtB,GAAM,GAAM,GAY9B,OACIuB,MAAO,SACPtC,KAAM,QACNH,MAAO,YACPmB,KAAM,wBACNR,QAAQ,EACR+B,WAAY,WACR,MAAMC,EAAMhE,EAAOiE,UAAU,4BAC7B,OAIoB,KAHhB,OACA,MACA,UACFC,QAAQF,IAEdG,KAAM,aAENC,OAAQ,SAAU9D,EAAKC,EAAQ8D,EAAUC,GACrCjE,EAAYC,IAEhB0C,OAAQ,SAAU1C,EAAKC,EAAQwC,EAAMsB,EAAUC,GAC3C,SAASC,EAAQC,EAAIC,GACjB,MAAMC,EAAMpE,EAAIO,MAAM,aAAa6C,IAAI,YACvC,GAAIgB,GAAOA,EAAItB,OAAQ,CACnB,MAAM1B,EAAOgD,EAAI,GAAGhD,KACpBA,EAAKiD,UAAYjD,EAAKH,SACtBiD,EAAG9C,QAEC+C,GACAD,EAAG,MAIflE,EAAIO,MAAM,YAAY2C,GAAG,QAAS,WAC9B/B,EAAWnB,EAAKC,EAAQ,QAE5BD,EAAIO,MAAM,eAAe2C,GAAG,QAAS,WACjCe,EAAQ,SAAU7C,IA9C9B,SAAoBpB,EAAKC,EAAQmB,GAC7BzB,EAAWO,QAAQ,SACfC,QAAS,SACTwB,KAAMP,IACPhB,KAAKC,IACJN,EAAYC,KACb6B,MAAMC,IACLvC,KAAKwC,MAAM,WAAYlC,EAAE,8BAA+BiC,KAwChDwC,CAAWtE,EAAKC,EAAQmB,OAGhCpB,EAAIO,MAAM,aAAa2C,GAAG,QAAS,WAC/Be,EAAQ,SAAU7C,GACdD,EAAWnB,EAAKC,EAAQmB,OAGhCpB,EAAIO,MAAM,eAAe2C,GAAG,QAAS,WACjCe,EAAQ,SAAU7C,GACdD,EAAWnB,EAAKC,EAAQ,KAAMmB,EAAKJ,SAI/CuD,KAAM,SAAUvE,EAAKC,EAAQ8D,EAAUC","file":"../module-users.js","sourcesContent":["define(['./locales'], function (Translations) {\n    'use strict';\n    const Locales = OSjs.require('core/locales');\n    const Dialog = OSjs.require('core/dialog');\n    const Config = OSjs.require('core/config');\n    const Connection = OSjs.require('core/connection');\n    const Window = OSjs.require('core/window');\n    const _ = Locales.createLocalizer(Translations);\n    function renderUsers(win, scheme) {\n        Connection.request('users', { command: 'list' }).then(users => {\n            if (users instanceof Array) {\n                win._find('UsersList').clear().add(users.map(function (iter, idx) {\n                    return {\n                        value: iter,\n                        columns: [\n                            { label: iter.id },\n                            { label: iter.username },\n                            { label: iter.name }\n                        ]\n                    };\n                }));\n            }\n        });\n    }\n    function showDialog(win, scheme, data, id) {\n        win._toggleDisabled(true);\n        if (id) {\n            Dialog.create('Input', {\n                message: _('Set user password'),\n                type: 'password'\n            }, function (ev, button, value) {\n                if (!value) {\n                    win._toggleDisabled(false);\n                    return;\n                }\n                Connection.request('users', {\n                    command: 'passwd',\n                    user: {\n                        password: value,\n                        id: id\n                    }\n                }).then(() => {\n                    win._toggleDisabled(false);\n                    renderUsers(win, scheme);\n                }).catch(err => {\n                    win._toggleDisabled(false);\n                    OSjs.error('Settings', _('Error while managing users'), err);\n                });\n            });\n            return;\n        }\n        const action = data === null ? 'add' : 'edit';\n        data = data || {};\n        const nwin = new Window('SettingsUserWindow', {\n            icon: win._app.__metadata.icon,\n            title: win._app.__metadata.name,\n            width: 400,\n            height: 250\n        }, win._app);\n        nwin._on('destroy', function (root) {\n            win._toggleDisabled(false);\n        });\n        nwin._on('init', function (root) {\n            scheme.render(nwin, nwin._name);\n            if (Object.keys(data).length) {\n                nwin._find('UserUsername').set('value', data.username);\n                nwin._find('UserName').set('value', data.name);\n                nwin._find('UserGroups').set('value', (data.groups || []).join(','));\n            }\n            nwin._find('ButtonClose').on('click', function () {\n                nwin._close();\n            });\n            nwin._find('ButtonOK').on('click', function () {\n                data.username = nwin._find('UserUsername').get('value');\n                data.name = nwin._find('UserName').get('value') || data.username;\n                data.groups = nwin._find('UserGroups').get('value').replace(/\\s/g, '').split(',');\n                if (!data.username || !data.groups) {\n                    nwin._close();\n                    return;\n                }\n                Connection.request('users', {\n                    command: action,\n                    user: data\n                }).then(() => {\n                    renderUsers(win, scheme);\n                    nwin._close();\n                }).catch(err => {\n                    OSjs.error('Settings', _('Error while managing users'), err);\n                });\n            });\n        });\n        win._addChild(nwin, true, true);\n    }\n    function removeUser(win, scheme, data) {\n        Connection.request('users', {\n            command: 'remove',\n            user: data\n        }).then(users => {\n            renderUsers(win, scheme);\n        }).catch(err => {\n            OSjs.error('Settings', _('Error while managing users'), err);\n        });\n    }\n    return {\n        group: 'system',\n        name: 'Users',\n        label: 'LBL_USERS',\n        icon: 'apps/system-users.png',\n        button: false,\n        compatible: function () {\n            const cfg = Config.getConfig('Connection.Authenticator');\n            return [\n                'demo',\n                'pam',\n                'shadow'\n            ].indexOf(cfg) === -1;\n        },\n        init: function () {\n        },\n        update: function (win, scheme, settings, wm) {\n            renderUsers(win, scheme);\n        },\n        render: function (win, scheme, root, settings, wm) {\n            function _action(cb, te) {\n                const sel = win._find('UsersList').get('selected');\n                if (sel && sel.length) {\n                    const data = sel[0].data;\n                    data._username = data.username;\n                    cb(data);\n                } else {\n                    if (te) {\n                        cb(null);\n                    }\n                }\n            }\n            win._find('UsersAdd').on('click', function () {\n                showDialog(win, scheme, null);\n            });\n            win._find('UsersRemove').on('click', function () {\n                _action(function (data) {\n                    removeUser(win, scheme, data);\n                });\n            });\n            win._find('UsersEdit').on('click', function () {\n                _action(function (data) {\n                    showDialog(win, scheme, data);\n                });\n            });\n            win._find('UsersPasswd').on('click', function () {\n                _action(function (data) {\n                    showDialog(win, scheme, null, data.id);\n                });\n            });\n        },\n        save: function (win, scheme, settings, wm) {\n        }\n    };\n});"]}