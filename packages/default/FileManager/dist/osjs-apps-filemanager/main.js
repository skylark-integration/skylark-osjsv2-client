/**
 * osjs-apps-filemanager - 
 * @author 
 * @version v1.0.0
 * @link 
 * @license 
 */
define(["./locales","./scheme.html"],function(e,i){"use strict";const t=OSjs.require("utils/fs"),n=OSjs.require("vfs/fs"),o=OSjs.require("vfs/file"),s=OSjs.require("core/application"),a=OSjs.require("core/window"),r=OSjs.require("core/dialog"),l=OSjs.require("core/locales"),c=OSjs.require("utils/events"),h=OSjs.require("utils/misc"),d=OSjs.require("core/settings-manager"),u=OSjs.require("core/mount-manager"),f=OSjs.require("gui/element"),g=OSjs.require("utils/clipboard"),m=OSjs.require("utils/keycodes"),_=OSjs.require("core/config"),p=OSjs.require("core/theme"),w=OSjs.require("gui/notification"),v=l.createLocalizer(e);function S(e){var i=[];return(e.get("value")||[]).forEach(function(e){e.data.shortcut||i.push(e.data)}),i}function y(e,i,t){var n=e.destination,s=e.file;r.create("FileUpload",{dest:n,file:s},function(e,t,s){if("ok"!==t&&"complete"!==t)i(!1,!1);else{var a=o.fromUpload(n,s);i(!1,a)}},t)}var M={};class E extends a{constructor(e,i,n,s){super("ApplicationFileManagerWindow",{icon:i.icon,title:i.name,allow_drop:!0,width:650,height:420,translator:v},e),this.wasFileDropped=!1,this.currentPath=n,this.currentSummary={},this.viewOptions=h.argumentDefaults(s||{},{ViewNavigation:!0,ViewSide:!0},!0),this.history=[],this.historyIndex=-1;var a=this;this.settingsWatch=d.watch("VFS",function(){a._loaded&&a.changePath()}),this._on("drop:upload",function(i,t){e.upload(a.currentPath,t,a)}),this._on("drop:file",function(i,n){if(t.dirname(n.path)!==a.currentPath){var s=new o(t.pathJoin(a.currentPath,n.filename));a.wasFileDropped=s,e.copy(n,s,a)}}),this._on("keydown",function(i,n,s,r,l){if(c.keyCombination(i,"CTRL+V")){var h=g.getClipboard();h&&h instanceof Array&&h.forEach(function(i){if(i&&i instanceof o){var n=new o(t.pathJoin(a.currentPath,i.filename));e.copy(i,n,a)}})}else i.keyCode===m.DELETE&&e.rm(S(a._find("FileView")),a)}),this._on("destroy",function(){try{d.unwatch(a.settingsWatch)}catch(e){}})}init(e,t){const n=super.init(...arguments);var o,s=this,a=this.viewOptions.ViewType||"gui-list-view",r=!0===this.viewOptions.ViewSide,l=!0===this.viewOptions.ViewNavigation,c=h.cloneObject(d.get("VFS")||{}).scandir||{},u=!0===c.showHiddenFiles,f=!0===c.showFileExtensions;this._render("FileManagerWindow",i),"nw"!==_.getConfig("Connection.Type")&&window.location.protocol.match(/^file/)&&this._setWarning("VFS does not work when in standalone mode");var g={MenuClose:function(){s._close()},MenuCreateFile:function(){t.mkfile(s.currentPath,s)},MenuCreateDirectory:function(){t.mkdir(s.currentPath,s)},MenuUpload:function(){t.upload(s.currentPath,null,s)},MenuRename:function(){t.rename(S(o),s)},MenuDelete:function(){t.rm(S(o),s)},MenuInfo:function(){t.info(S(o),s)},MenuOpen:function(){t.open(S(o),s)},MenuDownload:function(){t.download(S(o),s)},MenuRefresh:function(){s.changePath()},MenuViewList:function(){s.changeView("gui-list-view",!0)},MenuViewTree:function(){s.changeView("gui-tree-view",!0)},MenuViewIcon:function(){s.changeView("gui-icon-view",!0)},MenuShowSidebar:function(){r=s.toggleSidebar(!r,!0)},MenuShowNavigation:function(){l=s.toggleNavbar(!l,!0)},MenuShowHidden:function(){u=s.toggleHidden(!u,!0)},MenuShowExtension:function(){f=s.toggleExtension(!f,!0)},MenuColumnFilename:function(){s.toggleColumn("filename",!0)},MenuColumnMIME:function(){s.toggleColumn("mime",!0)},MenuColumnCreated:function(){s.toggleColumn("ctime",!0)},MenuColumnModified:function(){s.toggleColumn("mtime",!0)},MenuColumnSize:function(){s.toggleColumn("size",!0)}};function m(e){var i=e.detail.func||e.detail.id;g[i]&&g[i]()}this._find("SubmenuFile").on("select",m);var p=this._find("SubmenuContext").on("select",m);this._find("SubmenuEdit").on("select",m);var w=this._find("SubmenuView").on("select",m);w.set("checked","MenuViewList","gui-list-view"===a),w.set("checked","MenuViewTree","gui-tree-view"===a),w.set("checked","MenuViewIcon","gui-icon-view"===a),w.set("checked","MenuShowSidebar",r),w.set("checked","MenuShowNavigation",l),w.set("checked","MenuShowHidden",u),w.set("checked","MenuShowExtension",f),this._find("GoLocation").on("enter",function(e){s.changePath(e.detail,null,!1,!0)}),this._find("GoBack").on("click",function(e){s.changeHistory(-1)}),this._find("GoNext").on("click",function(e){s.changeHistory(1)});var v=this._find("PanedView");return this._find("ToggleSideview").on("click",function(e){if(v.$element){var i=v.$element.getAttribute("data-toggled");v.$element.setAttribute("data-toggled",String("true"!==i))}}),this._find("SideView").on("activate",function(e){if(e&&e.detail&&e.detail.entries){var i=e.detail.entries[0];i&&s.changePath(i.data.root)}}),(o=this._find("FileView")).on("activate",function(e){e&&e.detail&&e.detail.entries&&s.checkActivation(e.detail.entries)}),o.on("select",function(e){e&&e.detail&&e.detail.entries&&s.checkSelection(e.detail.entries)}),o.on("contextmenu",function(e){e&&e.detail&&e.detail.entries&&s.checkSelection(e.detail.entries),p.show(e)}),this.renderSideView(),this.changeView(a,!1),this.toggleHidden(u,!1),this.toggleExtension(f,!1),this.toggleSidebar(r,!1),this.toggleNavbar(l,!1),this.changePath(this.currentPath),this.toggleColumn(),n}checkSelection(e){if(e=e||[],this._scheme){var i,n=this,o="",s=this._find("Statusbar");if(e&&e.length){i={files:0,directories:0,size:0},e.forEach(function(e){"dir"===e.data.type?i.directories++:(i.files++,i.size+=e.data.size)});var a=1===e.length&&!0===e[0].data.shortcut;o=v("Selected {0} files, {1} dirs, {2}",i.files,i.directories,t.humanFileSize(i.size)),r(i.files,i.directories,a)}else(i=this.currentSummary)&&(o=v("Showing {0} files ({1} hidden), {2} dirs, {3}",i.files,i.hidden,i.directories,t.humanFileSize(i.size))),r(!1,!1,!1);s.set("value",o)}function r(e,i,t){var o=!e||!!i,s=!(e||i);n._find("MenuRename").set("disabled",t||s),n._find("MenuDelete").set("disabled",t||s),n._find("MenuInfo").set("disabled",s),n._find("MenuDownload").set("disabled",o),n._find("MenuOpen").set("disabled",o),n._find("ContextMenuRename").set("disabled",t||s),n._find("ContextMenuDelete").set("disabled",t||s),n._find("ContextMenuInfo").set("disabled",s),n._find("ContextMenuDownload").set("disabled",o),n._find("ContextMenuOpen").set("disabled",o)}}checkActivation(e){var i=this;(e||[]).forEach(function(e){return"dir"===e.data.type?(i.changePath(e.data.path),!1):(s.createFromFile(new o(e.data)),!0)})}updateSideView(e){if(!this._destroyed&&this._scheme){var i=null,t=this.currentPath||"/";e&&this.renderSideView(),u.getModules({special:!0}).forEach(function(e,n){t.match(e.option("match"))&&(i=e.option("root"))}),this._find("SideView").set("selected",i,"root")}}renderSideView(){if(!this._destroyed&&this._scheme){var e=[];u.getModules({special:!0}).forEach(function(i,t){var n=[i.mounted()?"mounted":"unmounted"];i.isReadOnly()&&n.push("readonly gui-has-emblem"),e.push({value:i.options,className:n.join(" "),columns:[{label:i.option("title"),icon:p.getIcon(i.option("icon"))}],onCreated:function(e){i.isReadOnly()&&(e.style.backgroundImage="url("+p.getIcon("emblems/emblem-readonly.png","16x16")+")")}})});var i=this._find("SideView");i.clear(),i.add(e)}}onMountEvent(e,i){e&&("vfs:unmount"===i&&this.currentPath.match(e.option("match"))&&this.changePath(_.getDefaultPath()),this.updateSideView(e))}onFileEvent(e,i){this.currentPath!==t.dirname(e.path)&&this.currentPath!==e.path||this.changePath(null,this.wasFileDropped,!1,!1,!this.wasFileDroped)}changeHistory(e){-1!==this.historyIndex&&(e<0?this.historyIndex>0&&this.historyIndex--:e>0&&this.historyIndex<this.history.length-1&&this.historyIndex++,this.changePath(this.history[this.historyIndex],null,!0))}changePath(e,i,t,n,o){if(!this._destroyed&&this._scheme){this.wasFileDropped=!1,e=e||this.currentPath;var s=this,a=this._find("FileView");this._toggleLoading(!0),a.chdir({path:e,done:function(r,l){!s._destroyed&&s._scheme&&(e&&!r&&(s.currentPath=e,s.currentSummary=l,s._app&&s._app._setArgument("path",e),function(e){t||(s.historyIndex>=0&&s.historyIndex<s.history.length-1&&(s.history=[]),s.history[s.history.length-1]!==e&&s.history.push(e),s.history.length>1?s.historyIndex=s.history.length-1:s.historyIndex=-1),n&&(s.history=[e],s.historyIndex=0),s._setTitle(e,!0)}(e)),s._toggleLoading(!1),s.checkSelection([]),s.updateSideView(),i&&a&&a.set("selected",i.filename,"filename",{scroll:o}),s._find("GoLocation").set("value",e),s._find("GoBack").set("disabled",s.historyIndex<=0),s._find("GoNext").set("disabled",s.historyIndex<0||s.historyIndex>=s.history.length-1))}})}}changeView(e,i){!this._destroyed&&this._scheme&&(this._find("FileView").set("type",e,!!i),i&&this._app._setSetting("ViewType",e,!0))}toggleSidebar(e,i){if(this._destroyed||!this._scheme)return null;this.viewOptions.ViewSide=e;var t=this._find("SideContainer"),n=new f(t.$element.parentNode.querySelector("gui-paned-view-handle"));return e?(t.show(),n.show()):(t.hide(),n.hide()),i&&this._app._setSetting("ViewSide",e,!0),e}toggleVFSOption(e,i,t,n){if(this._destroyed||!this._scheme)return null;var o=this._find("FileView"),s=d.instance("VFS"),a={scandir:{}};return a.scandir[e]=t,s.set(null,a,null,n),o.set(i,t),t}toggleHidden(e,i){return this._destroyed||!this._scheme?null:this.toggleVFSOption("showHiddenFiles","dotfiles",e,i)}toggleExtension(e,i){return this._destroyed||!this._scheme?null:this.toggleVFSOption("showFileExtensions","extensions",e,i)}toggleNavbar(e,i){if(this._destroyed||!this._scheme)return null;this.viewOptions.ViewNavigation=e;var t=this._find("ToolbarContainer");return e?t.show():t.hide(),i&&this._app._setSetting("ViewNavigation",e,!0),e}toggleColumn(e,i){if(!this._destroyed&&this._scheme){var t=h.cloneObject(d.get("VFS")||{}).scandir||{},n=t.columns||["filename","mime","size"];if(e){var o=n.indexOf(e);o>=0?n.splice(o,1):n.push(e),t.columns=n,d.set("VFS","scandir",t,i)}var s=this._find("SubmenuView");s.set("checked","MenuColumnFilename",n.indexOf("filename")>=0),s.set("checked","MenuColumnMIME",n.indexOf("mime")>=0),s.set("checked","MenuColumnCreated",n.indexOf("ctime")>=0),s.set("checked","MenuColumnModified",n.indexOf("mtime")>=0),s.set("checked","MenuColumnSize",n.indexOf("size")>=0)}}}OSjs.Applications.ApplicationFileManager=class extends s{constructor(e,i){super("ApplicationFileManager",e,i)}init(e,i){super.init(...arguments);var t=this,n=this._getArgument("path")||_.getDefaultPath();this._on("vfs",function(e,i){var n=t._getMainWindow();n&&("vfs:mount"===e||"vfs:unmount"===e?n.onMountEvent(i,e):i.destination?(n.onFileEvent(i.destination,!0),n.onFileEvent(i.source)):n.onFileEvent(i))}),this._addWindow(new E(this,i,n,e))}download(e){e.length&&e.forEach(function(e){n.url(new o(e),{download:!0}).then(e=>window.open(e),{download:!0})})}rm(e,i){var t=this;if(e.length){var n=[];e.forEach(function(e){n.push(e.filename)}),n=n.join(", "),i._toggleDisabled(!0),r.create("Confirm",{buttons:["yes","no"],message:h.format(v("Delete **{0}** ?"),n)},function(n,s){i._toggleDisabled(!1),"ok"!==s&&"yes"!==s||e.forEach(function(e){e=new o(e),t._action("unlink",[e],function(){i.changePath(null)})})},i)}}info(e,i){e.length&&e.forEach(function(e){"file"===e.type&&r.create("FileInfo",{file:new o(e)},null,i)})}open(e){e.length&&e.forEach(function(e){"file"===e.type&&s.createFromFile(new o(e),{forceList:!0})})}rename(e,i){var n=this;e.length&&e.forEach(function(e){r.create("Input",{message:v("Rename **{0}**",e.filename),value:e.filename},function(s,a,r){"ok"===a&&r&&function(e,s){e=new o(e);var a=new o(e);a.filename=s,a.path=t.replaceFilename(e.path,s),n._action("move",[e,a],function(e){e||i.changePath(null,a)})}(e,r)},i).setRange(t.getFilenameRange(e.filename))})}mkfile(e,i){var t=this;function s(e,o){i._toggleDisabled(!1),o&&n.write(o,"",{},t).then(()=>i.changePath(null,o))}i._toggleDisabled(!0),r.create("Input",{value:"My new File",message:v("Create a new file in **{0}**",e)},function(a,c,h){if(h){var d=new o(e+"/"+h);n.exists(d).then(e=>e(!1,h)).catch((e,n)=>{n?(i._toggleDisabled(!0),r.create("Confirm",{buttons:["yes","no"],message:l._("DIALOG_FILE_OVERWRITE",d.filename)},function(e,i){s(0,d)},t)):s(0,d)})}else i._toggleDisabled(!1)},i)}mkdir(e,i){var n=this;i._toggleDisabled(!0),r.create("Input",{message:v("Create a new directory in **{0}**",e)},function(s,a,r){if(r){var l=new o(t.pathJoin(e,r));n._action("mkdir",[l],function(){i._toggleDisabled(!1),i.changePath(null,l)})}else i._toggleDisabled(!1)},i)}copy(e,i,t){var o=this,s=r.create("FileProgress",{message:v("Copying **{0}** to **{1}**",e.filename,i.path)},function(){},t);t._toggleLoading(!0);const a=e=>{t._toggleLoading(!1);try{s._close()}catch(e){}e&&OSjs.error(l._("ERR_GENERIC_APP_FMT",o.__label),l._("ERR_GENERIC_APP_REQUEST"),e)};n.copy(e,i,{dialog:s},this._app).then(()=>a(!1)).catch(a)}upload(e,i,t){var n=this;i?function(){function o(e,i){t._toggleLoading(!1),e&&OSjs.error(l._("ERR_GENERIC_APP_FMT",n.__label),l._("ERR_GENERIC_APP_REQUEST"),e)}t._toggleLoading(!0),i?Promise.each(i,i=>new Promise((t,o)=>{y({file:i,destination:e},function(e){e?o(e):t()},n)})).then(e=>o(null)).catch(o):y({destination:e},o,n)}():r.create("FileUpload",{dest:e},function(e,i,n){n&&t.changePath(null,n)},t)}showStorageNotification(e){M[e]||(M[e]=!0,w.create({title:"External Storage",message:"Using external services requires authorization. A popup-window may appear.",icon:p.getIcon("status/dialog-information.png","32x32")}))}_action(e,i,t){t=t||function(){},n[e].apply(n,i.concat(null,this)).then(e=>t(!1,e)).catch(e=>{OSjs.error(l._("ERR_GENERIC_APP_FMT",this.__label),l._("ERR_GENERIC_APP_REQUEST"),e),t(e)})}}});
//# sourceMappingURL=sourcemaps/main.js.map
