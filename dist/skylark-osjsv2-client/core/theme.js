/**
 * skylark-osjsv2-client - A version of osjs-client that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-osjsv2-client/
 * @license MIT
 */
define(["./settings-manager","./config","../vfs/file","./package-manager","../utils/fs","../utils/compability","../utils/dom"],function(e,t,n,i,o,s,c){"use strict";return new class{constructor(){const e=s.getCompability();this.settings=null,this.$themeScript=null,this.audioAvailable=!!e.audio,this.oggAvailable=!!e.audioTypes.ogg}init(t){this.VFS=t,this.settings=e.instance("__theme__",{enableSounds:!0,styleTheme:"default",soundTheme:"default",iconTheme:"default",sounds:{}})}update(e,t){this.settings.set(null,e),t&&this.setTheme(e)}destroy(){this.$themeScript=c.$remove(this.$themeScript)}themeAction(e,t){const n=this.getStyleTheme();t=t||[];try{if(OSjs.Themes[n])return OSjs.Themes[n][e].apply(null,t)}catch(e){console.warn(e)}return null}_setBackground(e){const t=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,n={image:"normal","image-center":"center","image-fill":"fill","image-strech":"strech"};let i="color",o="none";if(e.wallpaper&&e.background.match(/^image/)&&(o=e.wallpaper,i=n[e.background]||"default"),"none"!==o)try{this.VFS.url(o).then(e=>(o="url('"+e+"')",document.body.style.backgroundImage=o,!0))}catch(e){console.warn(e)}else document.body.style.backgroundImage=o;e.backgroundColor&&(document.body.style.backgroundColor=e.backgroundColor),e.fontFamily&&(document.body.style.fontFamily=e.fontFamily),document.body.style.backgroundAttachment=t?"fixed":"scroll",document.body.setAttribute("data-background-style",i)}getThemeCSS(e){let n=t.getConfig("Connection.RootURI","/");return null===e?n+"blank.css":(n=t.getConfig("Connection.ThemeURI"))+"/"+e+".css"}setTheme(e){this.themeAction("destroy"),this.setThemeScript(this.getThemeResource("theme.js")),document.body.setAttribute("data-style-theme",e.styleTheme),document.body.setAttribute("data-icon-theme",e.iconTheme),document.body.setAttribute("data-sound-theme",e.soundTheme),document.body.setAttribute("data-animations",String(e.animations)),this._setBackground(e),this.settings.set(null,e)}setThemeScript(e){this.$themeScript&&(this.$themeScript=c.$remove(this.$themeScript)),e&&(this.$themeScript=c.$createJS(e,null,()=>{this.themeAction("init")}))}getStyleTheme(e,t){const n=this.settings.get("styleTheme")||null;if(e){let e=null;if(n&&this.getStyleThemes().forEach(function(t){t&&t.name===n&&(e=t)}),e&&!0===t){const t=document.createElement("div");t.style.visibility="hidden",t.style.position="fixed",t.style.top="-10000px",t.style.left="-10000px",t.style.width="1em",t.style.height="1em",document.body.appendChild(t);const n=t.offsetWidth;if(t.parentNode.removeChild(t),"string"==typeof e.style.window.margin&&e.style.window.margin.match(/em$/)){const t=parseFloat(e.style.window.margin);e.style.window.margin=t*n}if("string"==typeof e.style.window.border&&e.style.window.border.match(/em$/)){const t=parseFloat(e.style.window.border);e.style.window.border=t*n}}return e}return n}getThemeResource(e,n){e=e||null,n=n||null;const i=t.getConfig("Connection.ThemeURI");var o,s;return e&&(s=this.getStyleTheme(),(o=e).match(/^\//)||(o="base"===n||null===n?`${i}/${s}/${o}`:`${i}/${s}/${n}/${o}`),e=o),e}getSound(e){if((e=e||null)&&!e.match(/^(https?:)?\//)){const n=this.getSoundTheme();e=`${t.getConfig("Connection.SoundURI")}/${n}/${e}.${this.oggAvailable?"oga":"mp3"}`}return e}playSound(e,t){const n=this.getSoundFilename(e);if(!n)return console.debug("playSound()","Cannot play sound, no compability or not enabled!"),null;void 0===t&&(t=1);const i=this.getSound(n);console.debug("playSound()",e,n,i,t);const o=new Audio(i);return o.volume=t,o.play(),o}getIcon(e,n){return e=e||"",n=n||"16x16",e.match(/^(https:?)?\//)||(e=`${t.getConfig("Connection.IconURI")}/${this.getIconTheme()}/${n}/${e}`),e}getFileIcon(e,t,s){if(s=s||"mimetypes/text-x-preview.png","object"!=typeof e||e instanceof n||(e=new n(e)),!e.filename)throw new Error("Filename is required for getFileIcon()");const c=[{match:"application/pdf",icon:"mimetypes/x-office-document.png"},{match:"application/zip",icon:"mimetypes/package-x-generic.png"},{match:"application/x-python",icon:"mimetypes/text-x-script.png"},{match:"application/x-lua",icon:"mimetypes/text-x-script.png"},{match:"application/javascript",icon:"mimetypes/text-x-script.png"},{match:"text/html",icon:"mimetypes/text-html.png"},{match:"text/xml",icon:"mimetypes/text-html.png"},{match:"text/css",icon:"mimetypes/text-x-script.png"},{match:"osjs/document",icon:"mimetypes/x-office-document.png"},{match:"osjs/draw",icon:"mimetypes/image-x-generic.png"},{match:/^text\//,icon:"mimetypes/text-x-generic.png"},{match:/^audio\//,icon:"mimetypes/audio-x-generic.png"},{match:/^video\//,icon:"mimetypes/video-x-generic.png"},{match:/^image\//,icon:"mimetypes/image-x-generic.png"},{match:/^application\//,icon:"mimetypes/application-x-executable.png"}];if("dir"===e.type)s="places/folder.png";else if("trash"===e.type)s="places/user-trash.png";else if("application"===e.type){const n=o.filename(e.path),s=i.getPackage(n);if(s)return s.icon.match(/^((https?:)|\.)?\//)?i.getPackageResource(n,s.icon):this.getIcon(s.icon,t)}else{const t=e.mime||"application/octet-stream";c.every(e=>{let n=!1;return!(n="string"==typeof e.match?t===e.match:t.match(e.match))||(s=e.icon,!1)})}return this.getIcon(s,t)}getIconTheme(){return this.settings.get("iconTheme","default")}getSoundTheme(){return this.settings.get("soundTheme","default")}getSoundFilename(e){return!!(this.audioAvailable&&this.settings.get("enableSounds")&&e)&&(this.settings.get("sounds",{})[e]||null)}getStyleThemes(){return t.getConfig("Styles",[])}getSoundThemes(){return t.getConfig("Sounds",[])}getIconThemes(){return t.getConfig("Icons",[])}}});
//# sourceMappingURL=../sourcemaps/core/theme.js.map
