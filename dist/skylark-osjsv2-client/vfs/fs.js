/**
 * skylark-osjsv2-client - A version of osjs-client that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-osjsv2-client/
 * @license MIT
 */
define(["../utils/fs","./file","./filedataurl","../core/process","../core/mount-manager","../core/package-manager","../core/settings-manager","../core/connection","../core/locales"],function(e,t,r,n,o,i,c,a,u){"use strict";let s=[];function h(e,t){e?console.error("VFS operation without callback caused an error",e):console.warn("VFS operation without callback",t)}function _(e,t){const module=o.getModuleFromPath(e.path);if(module){const r=module.option("match"),n=module.option("options");if(n&&n.alias)return t?module:e.path.replace(r,n.alias)}return!1}function l(e,r,n){if("string"==typeof e?e=new t(e):"object"==typeof e&&e.path&&(e=new t(e)),!(e instanceof t))throw new TypeError(r||u._("ERR_VFS_EXPECT_FILE"));const i=_(e);i&&(e.path=i);const c=o.getModuleFromPath(e.path);if(!c)throw new Error(u._("ERR_VFSMODULE_NOT_FOUND_FMT",e.path));if(n&&c.isReadOnly())throw new Error(u._("ERR_VFSMODULE_READONLY_FMT",c.name));return e}function f(e,t){const r=o.getModuleFromPath(e.path),n=o.getModuleFromPath(t.path);return!r||!n||r===n||(!!(r&&n&&r.option("internal")&&n.option("internal"))||r.option("transport")===n.option("tranport"))}function m(e,t){return(t=t||{}).overwrite?Promise.resolve():new Promise((t,r)=>{P(e).then(e=>e?r(new Error(u._("ERR_VFS_FILE_EXISTS"))):t()).catch(e=>{e&&console.warn("existsWrapper() error",e),r(e)})})}function E(e,t,r,n,o){return console.info("VFS operation",...arguments),e?new Promise((i,c)=>{e.request(t,r,n).then(n=>a.instance.onVFSRequestCompleted(e,t,r,n,o).then(()=>i(n)).catch(c)).catch(c)}):Promise.reject(new Error(u._("ERR_VFSMODULE_INVALID")))}function p(e,t,r,n,i,c){return new Promise((c,a)=>{if(r&&!(r instanceof Object))return void a(new TypeError(u._("ERR_ARGUMENT_FMT","VFS::"+e,"options","Object",typeof r)));const s=o.getModuleFromPath(n);s?E(s,e,t,r,i).then(c).catch(a):a(new Error(u._("ERR_VFSMODULE_NOT_FOUND_FMT",n)))})}function R(e,r,i){function c(t){n.message(e,t,{source:i?i.__pid:null}),function(e,t){s.forEach(function(r){const n=r.path;function o(e){return"dir"===r.type?e.path.substr(0,n.length)===n:e.path===n}let i=!1;t.destination?(i=o(t.destination))||(i=o(t.source)):i=o(t),i&&r.cb(e,t)})}(e,r)}const a=function(){function e(e){if(e instanceof t){const r=new t(e),n=function(e){let t=null;return o.getModules().forEach(function(r){if(!t&&r.option("options").alias){const n=r.option("options").alias;e.path.substr(0,n.length)===n&&(t=r)}}),t}(r);if(n)return r.path=r.path.replace(n.option("options").alias,n.option("root")),r}return!1}return r instanceof t?e(r):r&&r.destination&&r.source?{source:e(r.source),destination:e(r.destination)}:null}();c(r);const u=a.source||a.destination;a&&(a instanceof t||u)&&(u&&(a.source=a.source||r.source,a.destination=a.destination||r.destination),c(a))}function w(e,t,r,n){if(r=r||{},arguments.length<2)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{e=l(e,u._("ERR_VFS_EXPECT_SRC_FILE")),t=l(t,u._("ERR_VFS_EXPECT_DST_FILE"),!0)}catch(e){return Promise.reject(e)}function i(e){r.dialog&&r.dialog.setProgress(e)}const c=new Promise((c,a)=>{m(t,r).then(()=>{const u=o.getModuleFromPath(e.path),s=o.getModuleFromPath(t.path);return f(e,t)?E(u,"move",[e,t],r,n).then(()=>(i(100),c(!0))).catch(a):E(u,"read",[e],r,n).then(o=>(i(50),E(s,"write",[t,o],r,n).then(t=>E(u,"unlink",[e],r,n).then(e=>(i(100),c(e))).catch(a)).catch(a))).catch(a),!0}).catch(a)});return new Promise((e,t)=>{c.then(e).catch(e=>{i(100),t(new Error(u._("ERR_VFSMODULE_MOVE_FMT",e)))})})}function P(e){if(arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{e=l(e)}catch(e){return Promise.reject(e)}return p("exists",[e],{},e.path,null)}return{broadcastMessage:R,find:function(e,t,r){if(r=r||{},arguments.length<2)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{e=l(e)}catch(e){return Promise.reject(e)}return p("find",[e,t],r,e.path,null)},scandir:function(r,n){const o=c.get("VFS");if(n=n||{},arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));const i=new t(r),a=_(i,!0);try{r=l(r)}catch(e){return Promise.reject(e)}return new Promise((c,u)=>{p("scandir",[r],n,r.path,null).then(u=>{if(u instanceof Array&&(u=e.filterScandir(u,n,o),a&&(u=u.map(function(r){const n=!0===r.shortcut,o=new t(r);if(!n){const t=r.path.replace(/\/?$/,""),n=(a.option("options")||{}).alias.replace(/\/?$/,"");o.path=e.pathJoin(a.option("root"),t.replace(n,""))}return o})),!1!==n.backlink)){const n=function(r,n,o,i){let c="/"===r.path.split("://")[1].replace(/\/+/g,"/").replace(/^\/?/,"/");return o&&(c=i.path===o.root),!c&&!n.some(function(e){return".."===e.filename})&&new t({filename:"..",path:e.dirname(r.path),mime:null,size:0,type:"dir"})}(r,u,a,i);n&&u.unshift(n)}return c(u)}).catch(u)})},write:function(t,n,i,c){if(i=i||{},arguments.length<2)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{t=l(t,null,!0)}catch(e){return Promise.reject(e)}return new Promise((a,s)=>{const h=o.getModuleFromPath(t.path);(function(t,n){const o=(t,r,o,i)=>{e[t](r,n,function(e,t){e?i(new Error(e)):o(t)})};return new Promise((e,n)=>{try{if("string"==typeof t){if(t.length)return o("textToAb",t,e,n)}else{if(t instanceof r)return o("dataSourceToAb",t.toString(),e,n);if(window.Blob&&t instanceof window.Blob)return o("blobToAb",t,e,n)}}catch(e){return n(e)}return e(t)})})(n,t.mime).then(e=>(E(h,"write",[t,e],i,c).then(a).catch(e=>{s(new Error(u._("ERR_VFSMODULE_WRITE_FMT",e)))}),!0)).catch(e=>{s(new Error(u._("ERR_VFSMODULE_WRITE_FMT",e)))})})},read:function(t,r){if(r=r||{},arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{t=l(t)}catch(e){return Promise.reject(e)}return new Promise((n,i)=>{E(o.getModuleFromPath(t.path),"read",[t],r).then(o=>{if(r.type){const c={datasource:()=>new Promise((r,n)=>{e.abToDataSource(o,t.mime,function(e,t){return e?n(e):r(t)})}),text:()=>new Promise((r,n)=>{e.abToText(o,t.mime,function(e,t){return e?n(e):r(t)})}),blob:()=>new Promise((r,n)=>{e.abToBlob(o,t.mime,function(e,t){return e?n(e):r(t)})}),json:()=>new Promise((r,n)=>{e.abToText(o,t.mime,function(e,t){let o;if("string"==typeof t)try{o=JSON.parse(t)}catch(e){console.warn("VFS::read()","readToJSON",e.stack,e)}return e?n(e):r(o)})})},a=r.type.toLowerCase();if(c[a])return c[a]().then(n).catch(i)}return n(o)}).catch(e=>{i(new Error(u._("ERR_VFSMODULE_READ_FMT",e)))})})},copy:function(e,t,r,n){if(r=r||{},arguments.length<2)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{e=l(e,u._("ERR_VFS_EXPECT_SRC_FILE")),t=l(t,u._("ERR_VFS_EXPECT_DST_FILE"),!0)}catch(e){return Promise.reject(e)}function i(e){r.dialog&&r.dialog.setProgress(e)}(r=Object.assign({},{type:"binary",dialog:null},r)).arrayBuffer=!0;const c=new Promise((c,a)=>{m(t,r).then(()=>{const u=o.getModuleFromPath(e.path),s=o.getModuleFromPath(t.path);return f(e,t)?E(u,"copy",[e,t],r,n).then(()=>(i(100),c(!0))).catch(a):E(u,"read",[e],r,n).then(e=>(i(50),E(s,"write",[t,e],r,n).then(e=>(i(100),c(e))).catch(a))).catch(a),!0}).catch(a)});return new Promise((e,t)=>{c.then(e).catch(e=>{i(100),t(new Error(u._("ERR_VFSMODULE_COPY_FMT",e)))})})},move:w,rename:function(e,t){return w(...arguments)},unlink:function(r,n,o){if(n=n||{},arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{r=l(r,null,!0)}catch(e){return Promise.reject(e)}return new Promise((a,u)=>{p("unlink",[r],n,r.path,o).then(n=>(c.instance("PackageManager").get("PackagePaths",[]).some(function(n){const o=new t(n);return e.dirname(r.path)===o.path})&&i.generateUserMetadata(function(){}),a(n))).catch(u)})},mkdir:function(e,t,r){if(t=t||{},arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{e=l(e,null,!0)}catch(e){return Promise.reject(e)}return p("mkdir",[e],t,e.path,r)},exists:P,fileinfo:function(e){if(arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{e=l(e)}catch(e){return Promise.reject(e)}return p("fileinfo",[e],{},e.path,null)},url:function(e,t){if(t=t||{},arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{e=l(e)}catch(e){return Promise.reject(e)}return p("url",[e],t,e.path,null)},upload:function(r,n,i){if(r=r||{},arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));if(!r.files)return Promise.reject(new Error(u._("ERR_VFS_UPLOAD_NO_FILES")));if(!r.destination)return Promise.reject(new Error(u._("ERR_VFS_UPLOAD_NO_DEST")));const c=new t(r.destination),a=o.getModuleFromPath(r.destination);return new Promise((o,s)=>{Promise.all(r.files.map(o=>{const u=o instanceof window.File?o.name:o.filename,s=new t(e.pathJoin(r.destination,u));return new Promise((e,t)=>{m(s,n).then(()=>E(a,"upload",[c,o],n,i).then(e).catch(t)).catch(t)})})).then(o).catch(e=>{s(new Error(u._("ERR_VFS_UPLOAD_FAIL_FMT",e)))})})},download:function(e){if(arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{e=l(e)}catch(e){return Promise.reject(e)}if(!e.path)return Promise.reject(new Error(u._("ERR_VFS_DOWNLOAD_NO_FILE")));const t=new Promise((t,r)=>{const n=o.getModuleFromPath(e);E(n,"download",[e],{}).then(()=>(n.option("internal")?n.download(e).then(t).catch(r):n.read(e).then(t).catch(r),!0))});return new Promise((e,r)=>{t.then(e).catch(e=>{r(new Error(u._("ERR_VFS_DOWNLOAD_FAILED",e)))})})},trash:function(e){if(arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{e=l(e)}catch(e){return Promise.reject(e)}return p("trash",[e],{},e.path,null)},untrash:function(e){if(arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{e=l(e)}catch(e){return Promise.reject(e)}return p("untrash",[e],{},e.path,null)},emptyTrash:function(){return p("emptyTrash",[],{},null,null)},freeSpace:function(e){if(arguments.length<1)return Promise.reject(new Error(u._("ERR_VFS_NUM_ARGS")));try{e=l(e)}catch(e){return Promise.reject(e)}return p("freeSpace",[o.getModuleFromPath(e.path,!1,!0).option("root")],{},e.path,null)},watch:function(e,t){if(t=t||h,arguments.length<2)return t(u._("ERR_VFS_NUM_ARGS")),-1;try{e=l(e)}catch(e){return Promise.reject(e)}return Promise.resolve(s.push({path:e.path,type:e.type,cb:t})-1)},unwatch:function(e){void 0!==s[e]&&delete s[e]},triggerWatch:function(e,t,r){R("vfs:"+e,t,r)}}});
//# sourceMappingURL=../sourcemaps/vfs/fs.js.map
