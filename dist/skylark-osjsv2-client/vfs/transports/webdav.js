/**
 * skylark-osjsv2-client - A version of osjs-client that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-osjsv2-client/
 * @license MIT
 */
define(["skylark-axios","../../core/connection","../../utils/fs","../../utils/misc","../transport","../file","../../core/config","../../core/locales"],function(t,e,r,n,o,s,a,i){"use strict";function c(t,e){return t.path.replace(e.option("match"),"")}function u(t,e,r){let o=r.host;r.cors||(o=n.parseurl(r.host,{username:r.username,password:r.password}).url);const s=c(e,t);return o.replace(/\/?$/,s.replace(/^\/?/,"/"))}function p(t,e,o){const a=o.option("root"),i=o.option("options")||{},u=c(e,o);let p=i.ns||"DAV";return":"!==p.substr(-1)&&(p+=":"),(t.children||[]).map(t=>{let e=function(t,e,r){const o=r.option("options")||{},s=n.parseurl(o.host).path;try{let r=t.getElementsByTagNameNS(e,"href")[0].textContent;return r.substr(s.length-1,r.length)}catch(t){console.warn(t)}return"/"}(t,p,o),i="file";return e.match(/\/$/)&&(i="dir",e=e.replace(/\/$/,"")||"/"),e!==u&&new s({id:function(t,e,r){try{return e.getElementsByTagNameNS(r,"getetag")[0].textContent}catch(t){}return null}(0,t,p),path:a+e.replace(/^\//,""),filename:r.filename(e),size:function(t,e,r){if("file"===t)try{return parseInt(e.getElementsByTagNameNS(r,"getcontentlength")[0].textContent,10)||0}catch(t){}return 0}(i,t,p),mime:function(t,e,r){if("file"===t)try{return e.getElementsByTagNameNS(r,"getcontenttype")[0].textContent||"application/octet-stream"}catch(t){return"application/octet-stream"}return null}(i,t,p),type:i})}).filter(t=>!1!==t)}return class extends o{_request(n,o,a,c,p){const h=o.mime||"application/octet-stream",l=new s(o,h),m=c.option("options")||{},d={},f=u(c,l,m);if(o.dest){const t=new s(o.dest,h);d.Destination=u(c,t,m)}return h&&(d["Content-Type"]=h),new Promise((s,a)=>{if(m.cors){const e={url:f,responseType:!0===p?"arraybuffer":"text",method:n,headers:d,data:o.data,auth:{username:m.username,password:m.password}};t(e).then(t=>s(t.data)).catch(t=>a(new Error(t.message||t)))}else{const t={url:f,method:n,binary:!0===p,mime:h,headers:d};e.request("curl",t).then(t=>{const e=t.httpCode;if(!t)return a(new Error(i._("ERR_VFS_REMOTEREAD_EMPTY")));if([200,201,203,204,205,207].indexOf(e)<0){const t=new Error(i._("ERR_VFSMODULE_XHR_ERROR")+": "+e);return t.httpCode=e,a(t)}return!0===p?r.dataSourceToAb(t.body,h,(t,e)=>t?a(new Error(t)):s(e)):s((E=t.body,(new DOMParser).parseFromString(E,"application/xml").firstChild))}).catch(a)}});var E}scandir(t,e,r){return new Promise((n,o)=>{this._request("PROPFIND",{path:t.path},e,r).then(e=>{n(e?p(e,t,r).map(t=>new s(t)):[])}).catch(o)})}read(t,e,r){return this._request("GET",{path:t.path,mime:t.mime},e,r,!0)}write(t,e,r,n){return this._request("PUT",{path:t.path,data:e,mime:t.mime},r,n)}unlink(t,e,r){return this._request("DELETE",{path:t.path},e,r)}copy(t,e,r,n){return this._request("COPY",{path:t.path,dest:e.path},r,n)}move(t,e,r,n){return this._request("MOVE",{path:t.path,dest:e.path},r,n)}exists(t,e,r){return new Promise((n,o)=>{this._request("PROPFIND",{path:t.path},e,r).then(()=>{n(!1)}).catch(t=>{404===t.httpCode?n(!1):(console.warn(t),n(!0))})})}mkdir(t,e,r){return this._request("MKCOL",{path:t.path},e,r)}url(t,e,r){const n=r.option("options")||{};let o=u(r,t,n);return n.cors||(o=a.getConfig("Connection.FSURI")+"/read?path="+encodeURIComponent(o)),Promise.resolve(o)}freeSpace(t){return Promise.resolve(-1)}}});
//# sourceMappingURL=../../sourcemaps/vfs/transports/webdav.js.map
