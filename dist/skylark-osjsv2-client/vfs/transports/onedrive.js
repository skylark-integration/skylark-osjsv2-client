/**
 * skylark-osjsv2-client - A version of osjs-client that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-osjsv2-client/
 * @license MIT
 */
define(["skylark-axios","../transport","../file","../../core/config","../../core/locales","../../helpers/windows-live-api","../../utils/fs","../fs"],function(e,r,n,t,i,o,a,s){"use strict";let l,c=!1;function d(e,r){console.debug("OneDrive::*onedriveCall()",e),(window.WL||{}).api(e).then(e=>{r(!1,e)},n=>{console.error("OneDrive::*onedriveCall()","error",n,e),r(n.error.message)})}function h(e){let r="file";return"folder"!==e.type&&"album"!==e.type||(r="dir"),r}function u(e,r,i){const o=e.replace(/^\/+/,"").replace(/\/+$/,""),s=i+(o?o+"/":o)+r.name;return new n({id:r.id,filename:r.name,size:r.size||0,path:s,mime:function(e){l||(l=t.getConfig("MIME.mapping",{}));let r=null;if("dir"!==h(e)){r="application/octet-stream";let n=a.filext(e.name);n.length&&l[n="."+n]&&(r=l[n])}return r}(r),type:h(r)})}function p(e,r){d({path:e+"/files",method:"GET"},(e,n)=>{e?r(e):(console.debug("OneDrive::*getFilesInFolder()","=>",n),r(!1,n.data||[]))})}function m(e,r,n){if(!n&&e.id)return void r(!1,e.id);let t=a.getPathFromVirtual(e.path).replace(/\/+/,"/");if(n&&(t=a.dirname(t)),"/"===t)return void r(!1,"me/skydrive");const o=t.replace(/^\/+/,"").split("/"),s=!o.length;let l="me/skydrive";!function e(r){const n=o.shift(),t=o.length<=0;let i;if(s)i=l;else if(n)return void p(l,(i,o)=>{let a;o=o||[],i?console.warn("OneDrive","resolvePath()","getFilesInFolder() error",i):(o.forEach(e=>{e&&e.name===n&&(a=e.id)}),a&&(l=a)),t?r(a):e(r)});t?r(i):e(r)}(e=>{e?r(!1,e):r(i._("ONEDRIVE_ERR_RESOLVE"))})}return class extends r{_init(){return new e((e,r)=>{const n={scope:["wl.signin","wl.skydrive","wl.skydrive_update"]};c?e(!0):o.create(n,n=>{n?r(new Error(n)):(c=!0,e(!0))})})}request(r,n,t,i){const o=arguments;return new e((e,r)=>{this._init().then(()=>super.request(...o).then(e).catch(r)).catch(r)})}scandir(r,t,i){return new e((e,t)=>{const o=a.getPathFromVirtual(r.path);m(r,(s,l)=>{s?t(new Error(s)):d({path:l,method:"GET"},(s,l)=>{s?t(new Error(s)):p(l.id,(s,l)=>{if(s)t(new Error(s));else{const t=function(e,r,t,i,o){const s=[];return"/"!==e&&s.push(new n({id:t.id,filename:"..",path:a.dirname(t.path),size:0,type:"dir"})),r.forEach(r=>{s.push(u(e,r,o))}),s}(o,l,r,0,i.option("root"));e(t)}})})})})}read(r,t,i){return new e((e,i)=>{this.url(r).then(o=>{const a=new n(o,r.mime);s.read(a,t).then(e).catch(i)}).catch(i)})}write(r,n){return new e((e,t)=>{const s="https://apis.live.net/v5.0/me/skydrive/files?access_token="+o.instance().accessToken,l=new FormData;a.addFormFile(l,"file",n,r),axios({url:s,method:"POST",responseType:"json",data:l}).then(r=>{const n=r.data;return n&&n.id?e(n.id):t(new Error(i._("ERR_APP_UNKNOWN_ERROR")))}).catch(t)})}copy(r,t){return new e((e,i)=>{t=new n(a.dirname(t.path)),m(r,(r,n)=>{r?i(new Error(r)):m(t,(r,t)=>{r?i(new Error(r)):d({path:n,method:"COPY",body:{destination:t}},(r,n)=>r?i(new Error(r)):e(!0))})})})}move(r,t){return new e((e,i)=>{t=new n(a.dirname(t.path)),m(r,(r,n)=>{r?i(new Error(r)):m(t,(r,t)=>{r?i(new Error(r)):d({path:n,method:"MOVE",body:{destination:t}},(r,n)=>r?i(new Error(r)):e(!0))})})})}exists(r){return new e((e,n)=>{this.fileinfo(r).then(()=>e(!0)).catch(()=>e(!1))})}fileinfo(r){return new e((e,n)=>{m(r,(r,t)=>{r?n(new Error(r)):d({path:t,method:"GET"},(r,t)=>{if(r)n(new Error(r));else{const r={};["created_time","id","link","name","type","updated_time","upload_location","description","client_updated_time"].forEach(e=>{r[e]=t[e]}),e(r)}})})})}url(r){return new e((e,n)=>{m(r,function(r,t){r?n(new Error(r)):d({path:t+"/content",method:"GET"},(r,t)=>{r?n(new Error(r)):e(t.location)})})})}mkdir(r){return new e((e,n)=>{m(r,(t,i)=>{t?n(t):d({path:i,method:"POST",body:{name:r.filename}},(r,t)=>r?n(new Error(r)):e(!0))},!0)})}upload(e,r){const t=new n({filename:r.name,path:a.pathJoin(e.path,r.name),mime:r.type,size:r.size});return this.write(t,r)}freeSpace(r){return e.resolve(-1)}unlink(r){return new e((e,n)=>{m(r,(r,t)=>{r?n(new Error(r)):d({path:t,method:"DELETE"},(r,t)=>r?n(new Error(r)):e(!0))})})}}});
//# sourceMappingURL=../../sourcemaps/vfs/transports/onedrive.js.map
