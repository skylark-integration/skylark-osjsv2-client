{"version":3,"sources":["helpers/windows-live-api.js"],"names":["define","MountManager","ServiceNotificationIcon","Preloader","Locales","Config","redirectURI","window","location","href","replace","SingletonInstance","WindowsLiveAPI","[object Object]","clientId","this","hasSession","loaded","inited","accessToken","lastScope","preloads","type","src","callback","preload","then","result","failed","length","join","catch","scope","console","debug","WL","_login","sort","currScope","toString","login","error","response","setTimeout","init","Event","subscribe","a","b","c","d","onLogin","onLogout","onLog","onSessionChange","client_id","display","redirect_uri","session","access_token","status","_","error_description","remove","unsubscribe","_removeRing","logout","warn","arguments","getSession","add","title","onClick","instance","create","args","_run","load","getConfig","e","stack"],"mappings":";;;;;;;AAAAA,QACI,wBACA,8BACA,qBACA,kBACA,kBACD,SAAUC,EAAcC,EAAyBC,EAAWC,EAASC,GACpE,aACA,MAAMC,EAAcC,OAAOC,SAASC,KAAKC,QAAQ,MAAO,IAAM,2BAC9D,IAAIC,EAAoB,WAClBC,EACFC,YAAYC,GACRC,KAAKC,YAAa,EAClBD,KAAKD,SAAWA,EAChBC,KAAKE,QAAS,EACdF,KAAKG,QAAS,EACdH,KAAKI,YAAc,KACnBJ,KAAKK,UAAY,KACjBL,KAAKM,WACGC,KAAM,aACNC,IAAK,6BAGjBV,WAEAA,KAAKW,GACDA,EAAWA,GAAY,aAEnBT,KAAKE,OACLO,GAAS,GAAO,GAEhBrB,EAAUsB,QAAQV,KAAKM,UAAUK,KAAKC,IAC7BA,EAAOC,OAAOC,SACfd,KAAKE,QAAS,GAElBO,EAASG,EAAOC,OAAOE,KAAK,SAC7BC,MAAM,IAAMP,KAGvBX,KAAKmB,EAAOR,GACRS,QAAQC,MAAM,yBAA0BF,GACxC,IAAIG,EAAK5B,OAAO4B,OAChB,MAAMC,EAAS,KACX,MAAMhB,GAAaL,KAAKK,eAAiBiB,OACnCC,GAAaN,OAAaK,OAC5BtB,KAAKC,YAAcI,EAAUmB,aAAeD,EAAUC,WACtDf,GAAS,GAAO,GAGpBT,KAAKyB,MAAMR,EAAO,CAACS,EAAOC,KAClBD,EACAjB,EAASiB,GAGbE,WAAW,KACPnB,GAAS,GAAO,IACjB,OAGXT,KAAK6B,KAAKH,IACFA,EACAjB,EAASiB,GAGRlC,OAAO4B,IAIZA,EAAK5B,OAAO4B,OACRpB,KAAKG,OACLkB,KAEArB,KAAKG,QAAS,EACdiB,EAAGU,MAAMC,UAAU,aAAc,CAACC,EAAGC,EAAGC,EAAGC,KACvCnC,KAAKoC,QAAQJ,EAAGC,EAAGC,EAAGC,KAE1Bf,EAAGU,MAAMC,UAAU,cAAe,CAACC,EAAGC,EAAGC,EAAGC,KACxCnC,KAAKqC,SAASL,EAAGC,EAAGC,EAAGC,KAE3Bf,EAAGU,MAAMC,UAAU,SAAU,CAACC,EAAGC,EAAGC,EAAGC,KACnCnC,KAAKsC,MAAMN,EAAGC,EAAGC,EAAGC,KAExBf,EAAGU,MAAMC,UAAU,qBAAsB,CAACC,EAAGC,EAAGC,EAAGC,KAC/CnC,KAAKuC,gBAAgBP,EAAGC,EAAGC,EAAGC,KAElCf,EAAGS,MACCW,UAAWxC,KAAKD,SAChB0C,QAAS,QACTC,aAAcnD,IACfoB,KAAKC,IACJM,QAAQC,MAAM,yBAA0B,KAAMP,GAC1CA,EAAO+B,UACP3C,KAAKI,YAAcQ,EAAO+B,QAAQC,cAAgB,MAEhC,cAAlBhC,EAAOiC,OACPpC,GAAS,GAAO,GACS,YAAlBG,EAAOiC,OACdxB,IAEAZ,EAASpB,EAAQyD,EAAE,wBAAyBlC,EAAOiC,OAAOrB,cAE/DZ,IACCM,QAAQQ,MAAM,yBAA0B,eAAgBd,GACxDH,EAASG,EAAOmC,uBAtCpBtC,EAASpB,EAAQyD,EAAE,yBA2C/BhD,cACIX,EAAwB6D,OAAO,oBAEnClD,OAAOW,GACHA,EAAWA,GAAY,aAEvB,MAAMW,EAAK5B,OAAO4B,OACdpB,KAAKC,YACLQ,GAAS,GAAO,GAEpBW,EAAGU,MAAMmB,YAAY,eACrB7B,EAAGU,MAAMC,UAAU,cAAe,KAC9B/B,KAAKkD,cACL9B,EAAGU,MAAMmB,YAAY,eACrBxC,GAAS,GAAO,KAEpBW,EAAG+B,SACHjE,EAAa8D,OAAO,YAExBlD,MAAMmB,EAAOR,GACT,MAAMW,EAAK5B,OAAO4B,OACdpB,KAAKC,WACLQ,GAAS,GAAO,GAGpBW,EAAGK,OACCR,MAAOA,EACPyB,aAAcnD,IACfoB,KAAKC,IACkB,cAAlBA,EAAOiC,OACPpC,GAAS,GAAO,GAEhBA,EAASpB,EAAQyD,EAAE,wBAExBlC,IACCH,EAASpB,EAAQyD,EAAE,yBAA0BlC,EAAOmC,sBAG5DjD,kBACIoB,QAAQkC,KAAK,oCAAqCC,WAClD,MACMV,GADKnD,OAAO4B,QACCkC,aAEftD,KAAKC,aADL0C,EAMR7C,UACIoB,QAAQkC,KAAK,4BAA6BC,WAC1CrD,KAAKC,YAAa,EAClBd,EAAwBoE,IAAI,qBACpBC,MAAOnE,EAAQyD,EAAE,kBACjBW,QAAS,KACLzD,KAAKmD,aAIrBrD,WACIoB,QAAQkC,KAAK,6BAA8BC,WAC3CrD,KAAKC,YAAa,EAClBD,KAAKkD,cAETpD,QACIoB,QAAQC,MAAM,0BAA2BkC,YA+BjD,OACIK,SA7BJ,WACI,OAAO9D,GA6BP+D,OA3BJ,SAAgBC,EAAMnD,GAElB,SAASoD,IACL,MAAM5C,EAAQ2C,EAAK3C,MACnBrB,EAAkBkE,KAAK7C,EAAOS,IAC1BjB,EAASiB,IAAgB,EAAO9B,KAGxC,GAPAgE,EAAOA,MAOHhE,EAEA,YADAiE,IAGJ,IAAI9D,EAAW,KACf,IACIA,EAAWT,EAAOyE,UAAU,2BAC9B,MAAOC,GACL9C,QAAQkC,KAAK,sBAAuBY,EAAGA,EAAEC,OAExClE,GAILH,EAAoB,IAAIC,EAAeE,GACvC8D,KAJIpD,EAASpB,EAAQyD,EAAE","file":"../../helpers/windows-live-api.js","sourcesContent":["define([\n    '../core/mount-manager',\n    './service-notification-icon',\n    '../utils/preloader',\n    '../core/locales',\n    '../core/config'\n], function (MountManager, ServiceNotificationIcon, Preloader, Locales, Config) {\n    'use strict';\n    const redirectURI = window.location.href.replace(/\\/$/, '') + '/windows-live-oauth.html';\n    let SingletonInstance = null;\n    class WindowsLiveAPI {\n        constructor(clientId) {\n            this.hasSession = false;\n            this.clientId = clientId;\n            this.loaded = false;\n            this.inited = false;\n            this.accessToken = null;\n            this.lastScope = null;\n            this.preloads = [{\n                    type: 'javascript',\n                    src: '//js.live.net/v5.0/wl.js'\n                }];\n        }\n        destroy() {\n        }\n        init(callback) {\n            callback = callback || function () {\n            };\n            if (this.loaded) {\n                callback(false, true);\n            } else {\n                Preloader.preload(this.preloads).then(result => {\n                    if (!result.failed.length) {\n                        this.loaded = true;\n                    }\n                    callback(result.failed.join('\\n'));\n                }).catch(() => callback());\n            }\n        }\n        load(scope, callback) {\n            console.debug('WindowsLiveAPI::load()', scope);\n            let WL = window.WL || {};\n            const _login = () => {\n                const lastScope = (this.lastScope || []).sort();\n                const currScope = (scope || []).sort();\n                if (this.hasSession && lastScope.toString() === currScope.toString()) {\n                    callback(false, true);\n                    return;\n                }\n                this.login(scope, (error, response) => {\n                    if (error) {\n                        callback(error);\n                        return;\n                    }\n                    setTimeout(() => {\n                        callback(false, true);\n                    }, 10);\n                });\n            };\n            this.init(error => {\n                if (error) {\n                    callback(error);\n                    return;\n                }\n                if (!window.WL) {\n                    callback(Locales._('WLAPI_LOAD_FAILURE'));\n                    return;\n                }\n                WL = window.WL || {};\n                if (this.inited) {\n                    _login();\n                } else {\n                    this.inited = true;\n                    WL.Event.subscribe('auth.login', (a, b, c, d) => {\n                        this.onLogin(a, b, c, d);\n                    });\n                    WL.Event.subscribe('auth.logout', (a, b, c, d) => {\n                        this.onLogout(a, b, c, d);\n                    });\n                    WL.Event.subscribe('wl.log', (a, b, c, d) => {\n                        this.onLog(a, b, c, d);\n                    });\n                    WL.Event.subscribe('auth.sessionChange', (a, b, c, d) => {\n                        this.onSessionChange(a, b, c, d);\n                    });\n                    WL.init({\n                        client_id: this.clientId,\n                        display: 'popup',\n                        redirect_uri: redirectURI\n                    }).then(result => {\n                        console.debug('WindowsLiveAPI::load()', '=>', result);\n                        if (result.session) {\n                            this.accessToken = result.session.access_token || null;\n                        }\n                        if (result.status === 'connected') {\n                            callback(false, true);\n                        } else if (result.status === 'success') {\n                            _login();\n                        } else {\n                            callback(Locales._('WLAPI_INIT_FAILED_FMT', result.status.toString()));\n                        }\n                    }, result => {\n                        console.error('WindowsLiveAPI::load()', 'init() error', result);\n                        callback(result.error_description);\n                    });\n                }\n            });\n        }\n        _removeRing() {\n            ServiceNotificationIcon.remove('Windows Live API');\n        }\n        logout(callback) {\n            callback = callback || function () {\n            };\n            const WL = window.WL || {};\n            if (this.hasSession) {\n                callback(false, false);\n            }\n            WL.Event.unsubscribe('auth.logout');\n            WL.Event.subscribe('auth.logout', () => {\n                this._removeRing();\n                WL.Event.unsubscribe('auth.logout');\n                callback(false, true);\n            });\n            WL.logout();\n            MountManager.remove('OneDrive');\n        }\n        login(scope, callback) {\n            const WL = window.WL || {};\n            if (this.hasSession) {\n                callback(false, true);\n                return;\n            }\n            WL.login({\n                scope: scope,\n                redirect_uri: redirectURI\n            }).then(result => {\n                if (result.status === 'connected') {\n                    callback(false, true);\n                } else {\n                    callback(Locales._('WLAPI_LOGIN_FAILED'));\n                }\n            }, result => {\n                callback(Locales._('WLAPI_LOGIN_FAILED_FMT', result.error_description));\n            });\n        }\n        onSessionChange() {\n            console.warn('WindowsLiveAPI::onSessionChange()', arguments);\n            const WL = window.WL || {};\n            const session = WL.getSession();\n            if (session) {\n                this.hasSession = true;\n            } else {\n                this.hasSession = false;\n            }\n        }\n        onLogin() {\n            console.warn('WindowsLiveAPI::onLogin()', arguments);\n            this.hasSession = true;\n            ServiceNotificationIcon.add('Windows Live API', [{\n                    title: Locales._('WLAPI_SIGN_OUT'),\n                    onClick: () => {\n                        this.logout();\n                    }\n                }]);\n        }\n        onLogout() {\n            console.warn('WindowsLiveAPI::onLogout()', arguments);\n            this.hasSession = false;\n            this._removeRing();\n        }\n        onLog() {\n            console.debug('WindowsLiveAPI::onLog()', arguments);\n        }\n    }\n    function instance() {\n        return SingletonInstance;\n    }\n    function create(args, callback) {\n        args = args || {};\n        function _run() {\n            const scope = args.scope;\n            SingletonInstance.load(scope, error => {\n                callback(error ? error : false, SingletonInstance);\n            });\n        }\n        if (SingletonInstance) {\n            _run();\n            return;\n        }\n        let clientId = null;\n        try {\n            clientId = Config.getConfig('WindowsLiveAPI.ClientId');\n        } catch (e) {\n            console.warn('getWindowsLiveAPI()', e, e.stack);\n        }\n        if (!clientId) {\n            callback(Locales._('WLAPI_DISABLED'));\n            return;\n        }\n        SingletonInstance = new WindowsLiveAPI(clientId);\n        _run();\n    }\n    return {\n        instance: instance,\n        create: create\n    };\n});"]}