{"version":3,"sources":["helpers/google-api.js"],"names":["define","MountManager","ServiceNotificationIcon","Preloader","Locales","b","jsonp","gapi","window","SingletonInstance","GoogleAPI","[object Object]","clientId","this","accessToken","userId","preloaded","authenticated","loaded","preloads","type","src","callback","preload","then","result","failed","length","join","catch","load","scope","client","auth","cb","authenticate","error","_","loadAll","finished","lload","forEach","i","indexOf","push","current","total","console","debug","_load","iter","args","name","Array","concat","a","c","d","call","apply","_next","init","info","signOut","e","warn","stack","remove","url","login","immediate","authorize","client_id","user_id","createRingNotification","add","title","onClick","revoke","handleAuthResult","authResult","error_subtype","id","access_token","oauth2","userinfo","get","execute","resp","res","msg","instance","create","_run","getConfig"],"mappings":"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","file":"../../helpers/google-api.js","sourcesContent":["define([\n    '../core/mount-manager',\n    './service-notification-icon',\n    '../utils/preloader',\n    '../core/locales',\n    '../core/config',\n    './then-jsonp'\n], function (MountManager, ServiceNotificationIcon, Preloader, Locales, b, jsonp) {\n    'use strict';\n    const gapi = window.gapi = window.gapi || {};\n    let SingletonInstance = null;\n    class GoogleAPI {\n        constructor(clientId) {\n            this.clientId = clientId;\n            this.accessToken = null;\n            this.userId = null;\n            this.preloaded = false;\n            this.authenticated = false;\n            this.loaded = [];\n            this.preloads = [{\n                    type: 'javascript',\n                    src: 'https://apis.google.com/js/api.js'\n                }];\n        }\n        destroy() {\n        }\n        init(callback) {\n            callback = callback || function () {\n            };\n            if (this.preloaded) {\n                callback(false, true);\n            } else {\n                Preloader.preload(this.preloads).then(result => {\n                    if (result.failed.length) {\n                        this.preloaded = true;\n                    }\n                    callback(result.failed.join('\\n'));\n                }).catch(callback);\n            }\n        }\n        load(load, scope, client, callback) {\n            const auth = cb => {\n                this.authenticate(scope, (error, result) => {\n                    if (error) {\n                        cb(error);\n                    } else {\n                        if (!this.authenticated) {\n                            cb(Locales._('GAPI_AUTH_FAILURE'));\n                            return;\n                        }\n                        cb(false, result);\n                    }\n                });\n            };\n            const loadAll = finished => {\n                const lload = [];\n                load.forEach(i => {\n                    if (this.loaded.indexOf(i) === -1) {\n                        lload.push(i);\n                    }\n                });\n                let current = 0;\n                let total = lload.length;\n                console.debug('GoogleAPI::load()', load, '=>', lload, scope);\n                const _load = (iter, cb) => {\n                    let args = [];\n                    let name = null;\n                    if (iter instanceof Array) {\n                        if (iter.length > 0 && iter.length < 3) {\n                            args = args.concat(iter);\n                            name = iter[0];\n                        }\n                    } else {\n                        args.push(iter);\n                        name = iter;\n                    }\n                    args.push((a, b, c, d) => {\n                        this.loaded.push(name);\n                        cb.call(this, a, b, c, d);\n                    });\n                    if (client) {\n                        gapi.client.load.apply(gapi, args);\n                    } else {\n                        gapi.load.apply(gapi, args);\n                    }\n                };\n                function _next() {\n                    if (current >= total) {\n                        finished();\n                    } else {\n                        _load(lload[current], () => {\n                            _next();\n                        });\n                        current++;\n                    }\n                }\n                _next();\n            };\n            this.init(error => {\n                if (error) {\n                    callback(error);\n                    return;\n                }\n                if (!window.gapi || !gapi.load) {\n                    callback(Locales._('GAPI_LOAD_FAILURE'));\n                    return;\n                }\n                auth(error => {\n                    if (error) {\n                        callback(error);\n                        return;\n                    }\n                    loadAll((error, result) => {\n                        callback(error, result, SingletonInstance);\n                    });\n                });\n            });\n        }\n        signOut(cb) {\n            cb = cb || function () {\n            };\n            console.info('GoogleAPI::signOut()');\n            if (this.authenticated) {\n                try {\n                    gapi.auth.signOut();\n                } catch (e) {\n                    console.warn('GoogleAPI::signOut()', 'failed', e);\n                    console.warn(e.stack);\n                }\n                this.authenticated = false;\n                ServiceNotificationIcon.remove('Google API');\n            }\n            MountManager.remove('GoogleDrive');\n            cb(false, true);\n        }\n        revoke(callback) {\n            console.info('GoogleAPI::revoke()');\n            if (!this.accessToken) {\n                callback(false);\n                return;\n            }\n            const url = 'https://accounts.google.com/o/oauth2/revoke?token=' + this.accessToken;\n            jsonp('GET', url).then(() => callback(true)).catch(() => callback(false));\n        }\n        authenticate(scope, callback) {\n            console.info('GoogleAPI::authenticate()');\n            callback = callback || function () {\n            };\n            const getUserId = cb => {\n                cb = cb || function () {\n                };\n                gapi.client.load('oauth2', 'v2', () => {\n                    gapi.client.oauth2.userinfo.get().execute(resp => {\n                        console.info('GoogleAPI::authenticate() => getUserId()', resp);\n                        cb(resp.id);\n                    });\n                });\n            };\n            const login = (immediate, cb) => {\n                console.info('GoogleAPI::authenticate() => login()', immediate);\n                cb = cb || function () {\n                };\n                gapi.auth.authorize({\n                    client_id: this.clientId,\n                    scope: scope,\n                    user_id: this.userId,\n                    immediate: immediate\n                }, cb);\n            };\n            const createRingNotification = () => {\n                ServiceNotificationIcon.remove('Google API');\n                ServiceNotificationIcon.add('Google API', [\n                    {\n                        title: Locales._('GAPI_SIGN_OUT'),\n                        onClick: () => {\n                            this.signOut();\n                        }\n                    },\n                    {\n                        title: Locales._('GAPI_REVOKE'),\n                        onClick: () => {\n                            this.revoke(() => {\n                                this.signOut();\n                            });\n                        }\n                    }\n                ]);\n            };\n            const handleAuthResult = (authResult, immediate) => {\n                console.info('GoogleAPI::authenticate() => handleAuthResult()', authResult);\n                if (authResult.error) {\n                    if (authResult.error_subtype === 'origin_mismatch' || authResult.error_subtype === 'access_denied' && !immediate) {\n                        const msg = Locales._('GAPI_AUTH_FAILURE_FMT', authResult.error, authResult.error_subtype);\n                        callback(msg);\n                        return;\n                    }\n                }\n                if (authResult && !authResult.error) {\n                    getUserId(id => {\n                        this.userId = id;\n                        if (id) {\n                            createRingNotification();\n                            this.authenticated = true;\n                            this.accessToken = authResult.access_token || null;\n                            callback(false, true);\n                        } else {\n                            callback(false, false);\n                        }\n                    });\n                } else {\n                    login(false, res => {\n                        handleAuthResult(res, false);\n                    });\n                }\n            };\n            gapi.load('auth:client', result => {\n                if (result && result.error) {\n                    const msg = Locales._('GAPI_AUTH_FAILURE_FMT', result.error, result.error_subtype);\n                    callback(msg);\n                    return;\n                }\n                login(true, res => {\n                    handleAuthResult(res, true);\n                });\n            });\n        }\n    }\n    function instance() {\n        return SingletonInstance;\n    }\n    function create(args, callback) {\n        const load = args.load || [];\n        const scope = args.scope || [];\n        const client = args.client === true;\n        function _run() {\n            SingletonInstance.load(load, scope, client, callback);\n        }\n        if (SingletonInstance) {\n            _run();\n            return;\n        }\n        let clientId = null;\n        try {\n            clientId = b.getConfig('GoogleAPI.ClientId');\n        } catch (e) {\n            console.warn('getGoogleAPI()', e, e.stack);\n        }\n        if (!clientId) {\n            callback(Locales._('GAPI_DISABLED'));\n            return;\n        }\n        SingletonInstance = new GoogleAPI(clientId);\n        _run();\n    }\n    return {\n        instance: instance,\n        create: create\n    };\n});"]}