/**
 * skylark-osjsv2-client - A version of osjs-client that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-osjsv2-client/
 * @license MIT
 */
define(["../core/dialog","../gui/element","../vfs/file","../core/settings-manager","../core/mount-manager","../utils/fs","../utils/misc","../vfs/fs","../core/locales","../core/config"],function(e,t,i,s,l,a,n,h,o,c){"use strict";return class extends e{constructor(e,t){if((e=Object.assign({},{file:null,type:"open",path:c.getDefaultPath(),filename:"",filetypes:[],extension:"",mime:"application/octet-stream",filter:[],mfilter:[],select:null,multiple:!1},e)).multiple="save"!==e.type&&!0===e.multiple,e.path&&e.path instanceof i&&(e.path=a.dirname(e.path.path)),e.file&&e.file.path&&(e.path=a.dirname(e.file.path),e.filename=e.file.filename,e.mime=e.file.mime,e.filetypes.length)){const t=e.filetypes[0];e.filename=a.replaceFileExtension(e.filename,t.extension),e.mime=t.mime}super("FileDialog",{title:e.title||o._("save"===e.type?"DIALOG_FILE_SAVE":"DIALOG_FILE_OPEN"),icon:"open"===e.type?"actions/document-open.png":"actions/documentsave-as.png",width:600,height:400},e,t),this.selected=null,this.path=e.path,this.settingsWatch=s.watch("VFS",()=>{this.changePath()})}destroy(){try{s.unwatch(this.settingsWatch)}catch(e){}return super.destroy(...arguments)}init(){const s=super.init(...arguments),r=this._find("FileView");r.set("filter",this.args.filter),r.set("filetype",this.args.select||""),r.set("defaultcolumns","true");const d=this._find("Filename"),g=this._find("HomeButton"),p=this._find("ModuleSelect"),f=()=>{let e=!1;"dir"!==this.args.select&&(e=!d.get("value").length),this._find("ButtonOK").set("disabled",e)};if(this._toggleLoading(!0),r.set("multiple",this.args.multiple),d.set("value",this.args.filename||""),this._find("ButtonMkdir").on("click",()=>{e.create("Input",{message:o._("DIALOG_FILE_MKDIR_MSG",this.path),value:"New folder"},(e,t,s)=>{if("ok"===t&&s){const e=a.pathJoin(this.path,s);h.mkdir(new i(e,"dir")).then(()=>this.changePath(e)).catch(e=>{OSjs.error(o._("DIALOG_FILE_ERROR"),o._("ERR_VFSMODULE_MKDIR"),e)})}},this)}),g.on("click",()=>{const e=c.getDefaultPath();this.changePath(e)}),r.on("activate",e=>{if(this.selected=null,"save"!==this.args.type&&d.set("value",""),e&&e.detail&&e.detail.entries){const t=e.detail.entries[0];t&&(this.selected=new i(t.data),"dir"!==this.selected.type&&d.set("value",this.selected.filename),this.checkSelection(e,!0))}}),r.on("select",e=>{if(this.selected=null,e&&e.detail&&e.detail.entries){const t=e.detail.entries[0];t&&(this.selected=new i(t.data),"dir"!==this.selected.type&&d.set("value",this.selected.filename))}f()}),"save"===this.args.type){const e=[];this.args.filetypes.forEach(t=>{e.push({label:n.format("{0} (.{1} {2})",t.label,t.extension,t.mime),value:t.extension})});const i=this._find("Filetype").add(e).on("change",e=>{const t=a.replaceFileExtension(d.get("value"),e.detail);d.set("value",t)});e.length<=1&&new t(i.$element.parentNode).hide(),d.on("enter",e=>{this.selected=null,this.checkSelection(e)}),d.on("change",e=>{f()}),d.on("keyup",e=>{f()})}else"dir"!==this.args.select&&this._find("ButtonMkdir").hide(),this._find("FileInput").hide();const m=l.getModuleFromPath(this.path).option("root"),u=l.getModules().filter(e=>!this.args.mfilter.length||this.args.mfilter.every(t=>t(e))).map(e=>({label:e.option("title")+(e.isReadOnly()?n.format(" ({0})",o._("LBL_READONLY")):""),value:e.option("root")}));return p.clear().add(u).set("value",m),p.on("change",e=>{this.changePath(e.detail,!0)}),this.changePath(),f(),s}changePath(e,t){const i=this._find("FileView"),s=this.path,a=()=>{try{const e=l.getModuleFromPath(s).option("root");this._find("ModuleSelect").set("value",e)}catch(e){console.warn("FileDialog::changePath()","resetLastSelection()",e)}};this._toggleLoading(!0),i.chdir({path:e||this.path,done:i=>{i?t&&a():e&&(this.path=e),this.selected=null,this._toggleLoading(!1)}})}checkFileExtension(){const e=this._find("Filename");let t=this.args.mime,i=e.get("value");if(this.args.filetypes.length&&(!i&&this.args.filename&&(i=this.args.filename),i.length)){const e=i.split(".").pop();let s=!1;this.args.filetypes.forEach(t=>(t.extension===e&&(s=t),!!s)),s=s||this.args.filetypes[0],i=a.replaceFileExtension(i,s.extension),t=s.mime}return{filename:i,mime:t}}checkSelection(t,s){if(this.selected&&"dir"===this.selected.type&&s)return this.changePath(this.selected.path),!1;if("save"===this.args.type){let s=this.checkFileExtension();return this.path&&s.filename?(this.selected=new i(this.path.replace(/^\//,"")+"/"+s.filename,s.mime),this._toggleDisabled(!0),h.exists(this.selected).then(i=>(this._toggleDisabled(!1),!this._destroyed&&(i?(this._toggleDisabled(!0),this.selected&&e.create("Confirm",{buttons:["yes","no"],message:o._("DIALOG_FILE_OVERWRITE",this.selected.filename)},(e,t)=>{this._toggleDisabled(!1),"yes"!==t&&"ok"!==t||this.closeCallback(e,"ok",this.selected)},this)):this.closeCallback(t,"ok",this.selected),!0))).catch(e=>{this._toggleDisabled(!1),this._destroyed||OSjs.error(o._("DIALOG_FILE_ERROR"),o._("DIALOG_FILE_MISSING_FILENAME"))}),!1):(OSjs.error(o._("DIALOG_FILE_ERROR"),o._("DIALOG_FILE_MISSING_FILENAME")),!1)}{if(!this.selected&&"dir"!==this.args.select)return OSjs.error(o._("DIALOG_FILE_ERROR"),o._("DIALOG_FILE_MISSING_SELECTION")),!1;let e=this.selected;e||"dir"!==this.args.select||(e=new i({filename:a.filename(this.path),path:this.path,type:"dir"})),this.closeCallback(t,"ok",e)}return!0}onClose(e,t){("ok"!==t||this.checkSelection(e))&&this.closeCallback(e,t,this.selected)}}});
//# sourceMappingURL=../sourcemaps/dialogs/file.js.map
