/**
 * skylark-osjsv2-client - A version of osjs-client that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-osjsv2-client/
 * @license MIT
 */
define(["skylark-axios","../utils/dom","./element","../core/config"],function(e,t,r,n){"use strict";function o(e,t,r){if(e){const n=e.children;let o=0;for(;n.length&&o<1e4;)r?t.parentNode.insertBefore(n[0],t):t.appendChild(n[0]),o++}}function a(e){return t.$clean(function(e){const t=(e||"").split("/>");let r="";for(let e=0;e<t.length-1;e++){const n=t[e].split("<");r+=t[e]+"></"+n[n.length-1].split(" ")[0]+">"}return r+t[t.length-1]}(e))}return class i{constructor(e){console.debug("GUIScheme::construct()",e),this.url=e,this.scheme=null,this.triggers={render:[]}}destroy(){t.$empty(this.scheme),this.scheme=null,this.triggers={}}on(e,t){this.triggers[e].push(t)}_trigger(e,t){t=t||[],this.triggers[e]&&this.triggers[e].forEach(e=>{e.apply(this,t)})}_load(e,t){let o=document.createDocumentFragment(),a=document.createElement("div");a.innerHTML=e,o.appendChild(a),this.scheme=o.cloneNode(!0),n.getConfig("DebugScheme")&&(console.group("Scheme::_load() validation",t),this.scheme.querySelectorAll("*").forEach(e=>{const t=e.tagName.toLowerCase(),n=r.getRegisteredElement(t);if(n){const r=n.metadata.allowedChildren;if(r instanceof Array&&r.length){e.children.map(e=>e.tagName.toLowerCase()).forEach((n,o)=>{-1===r.indexOf(n)&&console.warn(n,e.children[o],"is not a valid child of type",t)})}const o=n.metadata.allowedParents;if(o instanceof Array&&o.length){const r=e.parentNode.tagName.toLowerCase();-1===o.indexOf(r)&&console.warn(r,e.parentNode,"is in an invalid parent of type",t)}}}),console.groupEnd()),a=null,o=null}load(t,r){r=r||function(){},console.debug("GUIScheme::load()",this.url);let o=this.url;"/"===o.substr(0,1)||o.match(/^(https?|ftp)/)||(o=n.getBrowserPath(o)),e({url:o,method:"GET"}).then(e=>{const n=a(e.data);r(!1,n),this._load(n,o),t(!1,this.scheme)}).catch(e=>{t("Failed to fetch scheme: "+e.message),r(!0)})}getFragment(e,t){let r=null;return e&&(r=t?this.scheme.querySelector(t+'[data-id="'+e+'"]'):this.scheme.querySelector('application-window[data-id="'+e+'"]')||this.scheme.querySelector('application-dialog[data-id="'+e+'"]')||this.scheme.querySelector('application-fragment[data-id="'+e+'"]')),r}parse(e,n,a,i,s){const l=this.getFragment(e,n);if(console.debug("GUIScheme::parse()",e),!l)return console.error("GUIScheme::parse()","No fragment found",e+"@"+n),null;if(n=n||l.tagName.toLowerCase(),s=s||{},l){const c=l.cloneNode(!0);return!1!==s.resolve&&function(e,r){function n(){const n=r.querySelectorAll("gui-fragment");return!!n.length&&(n.forEach(function(r){const n=r.getAttribute("data-fragment-id");if(n){const t=e.getFragment(n,"application-fragment");t?o(t.cloneNode(!0),r.parentNode):console.warn("Fragment",n,"not found")}t.$remove(r)}),!0)}if(e){let e=!0;for(;e;)e=n()}}(this,c),r.parseNode(a,c,n,s,i,e),c}return null}render(e,n,a,i,s,l){(a=a||e._getRoot())instanceof r&&(a=a.$element),console.debug("GUIScheme::render()",n),o(this.parse(n,i,e,s,l),a),a.querySelectorAll("application-fragment").forEach(e=>{t.$remove(e)}),e._restored||function(t){if(t){const r=parseInt(t.getAttribute("data-width"),10)||0,n=parseInt(t.getAttribute("data-height"),10)||0,o=t.getAttribute("data-allow_maximize"),a=t.getAttribute("data-allow_minimize"),i=t.getAttribute("data-allow_close"),s=t.getAttribute("data-allow_resize");(!isNaN(r)&&r>0||!isNaN(n)&&n>0)&&e._resize(r,n),e._setProperty("allow_maximize",o),e._setProperty("allow_minimize",a),e._setProperty("allow_close",i),e._setProperty("allow_resize",s)}}(this.getFragment(n)),this._trigger("render",[a])}getHTML(){return this.scheme.firstChild.innerHTML}static fromString(e){const t=new i(null),r=a(e);return t._load(r,"<html>"),t}}});
//# sourceMappingURL=../sourcemaps/gui/scheme.js.map
